<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat - Koda Tutor</title>
  <link rel="stylesheet" href="../styles/main.css">
  <link rel="stylesheet" href="../styles/navbar.css">
  <link rel="stylesheet" href="../styles/toast.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="../scripts/utils.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #a0a0a0;
    }
    
    /* Input focus style */
    #messageInput:focus {
      box-shadow: 0 0 8px rgba(0, 163, 224, 0.3);
      border-color: #00A3E0;
      outline: none;
    }
    
    #messageInput {
      transition: all 0.3s ease;
      border-radius: 0.6rem;
    }
    
    /* Button styles */
    .suggested-question {
      border-color: #00A3E0;
      transition: all 0.2s ease;
      padding: 0.5rem 1rem;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    
    .suggested-question:hover {
      background-color: #00A3E0;
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 163, 224, 0.2);
    }
    
    #saveConversation {
      background-color: #00A3E0;
      transition: all 0.2s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    #saveConversation:hover {
      background-color: #0086b7;
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
    }
    
    /* Greeting container */
    .greeting-container {
      background-color: rgba(168, 213, 186, 0.2);
      border-radius: 0.75rem;
      padding: 1.25rem 2.5rem;
      text-align: center;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      border: 1px solid rgba(168, 213, 186, 0.3);
    }
    
    /* Centralized styles */
    .btn {
      background-color: #00A3E0;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn:hover {
      opacity: 0.9;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
    }
    .hidden {
      display: none;
    }
    .textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: vertical;
    }
    .textarea:focus {
      outline: none;
      border-color: #00A3E0;
      box-shadow: 0 0 0 2px rgba(0, 163, 224, 0.2);
    }

    /* Styles for headings within AI message bubbles */
    .bg-gray-100 h2 {
      font-size: 1.25em; /* Slightly larger */
      font-weight: 600; /* semibold */
      margin-top: 0.75em;
      margin-bottom: 0.25em;
    }
    .bg-gray-100 h3 {
      font-size: 1.1em;
      font-weight: 600;
      margin-top: 0.6em;
      margin-bottom: 0.2em;
    }
    .bg-gray-100 h4 {
      font-size: 1em; /* Same as base text, but bold */
      font-weight: 600;
      margin-top: 0.5em;
      margin-bottom: 0.15em;
    }
    /* Ensure paragraphs following headings have a bit of top margin */
    .bg-gray-100 h2 + p,
    .bg-gray-100 h3 + p,
    .bg-gray-100 h4 + p {
      margin-top: 0.25em;
    }
  </style>
</head>
<body class="font-eb-garamond min-h-screen flex" style="background: linear-gradient(to bottom, #F7F7F7, #FFFFFF)">
  <!-- Mobile Hamburger -->
  <div class="md:hidden fixed top-4 left-4 z-50 cursor-pointer p-2 mobile-touch-target" id="hamburger">
    <div class="w-6 h-0.5 bg-gray-800 mb-1"></div>
    <div class="w-6 h-0.5 bg-gray-800 mb-1"></div>
    <div class="w-6 h-0.5 bg-gray-800"></div>
  </div>

  <!-- Sidebar Navigation -->
  <div id="sidebar" class="fixed top-0 left-0 h-screen w-64 app-sidebar transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-40">
    <div class="flex flex-col h-full">
      <div class="logo-container pt-12 md:pt-5">
        <h1 class="app-logo">Koda <span>Tutor</span></h1>
        <button id="closeSidebar" class="absolute top-5 right-4 text-gray-300 hover:text-white md:hidden mobile-touch-target">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <!-- User Avatar Display -->
      <div class="p-4 flex justify-center border-b border-gray-700">
        <div class="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center overflow-hidden" id="chatAvatarContainer">
          <img id="chatSidebarUserAvatar" src="" alt="User Avatar" class="w-full h-full object-cover opacity-0 transition-opacity duration-300" title="Yo what's up?">
          <!-- Loading indicator -->
          <div id="chatAvatarLoading" class="absolute">
            <i class="fas fa-circle-notch fa-spin text-gray-400"></i>
          </div>
        </div>
      </div>
      
      <nav class="flex-1 overflow-y-auto py-4">
        <ul class="space-y-1 px-4">
          <li id="loggedInNav" class="hidden flex-col space-y-1">
            <a href="dashboard.html" class="nav-link">
              <i class="fas fa-compass"></i>
              <span class="mobile-readable">Dashboard</span>
            </a>
            <a href="chat.html" class="nav-link active">
              <i class="fas fa-comments"></i>
              <span class="mobile-readable">Chat</span>
            </a>
            <a href="podcasts.html" class="nav-link">
              <i class="fas fa-podcast"></i>
              <span class="mobile-readable">Podcasts</span>
            </a>
            <a href="settings.html" class="nav-link">
              <i class="fas fa-cog"></i>
              <span class="mobile-readable">Settings</span>
            </a>
          </li>
          <li id="loggedOutNav" class="hidden flex-col space-y-1">
            <a href="login.html" class="nav-link">
              <i class="fas fa-sign-in-alt"></i>
              <span>Login</span>
            </a>
            <a href="signup.html" class="nav-link">
              <i class="fas fa-user-plus"></i>
              <span>Sign Up</span>
            </a>
          </li>
        </ul>
      </nav>
      
      <div class="p-4 border-t border-gray-700">
        <button id="logout" class="logout-btn w-full">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="md:ml-64 flex-1 flex flex-col h-screen">
    <div class="flex-1 flex flex-col pt-20 md:pt-0">
      <div class="flex-1 flex flex-col bg-white">
        <!-- Chat Header -->
        <div class="p-6 border-b border-gray-200">
          <div class="mb-4">
            <h1 class="text-2xl font-semibold text-gray-800">Chat with Koda</h1>
          </div>
          <p class="text-gray-600 mb-4">I'm your friendly learning companion! Ask me questions, explore new topics, or discuss ideas you're curious about.</p>
        </div>

        <!-- Chat Container -->
        <div class="flex-1 flex flex-col min-h-0">
          <div id="chatContainer" class="flex-1 overflow-y-auto p-6 space-y-4">
            <!-- Messages will be loaded here -->
          </div>

          <!-- Input Area -->
          <div class="p-4 border-t border-gray-200 bg-white">
            <div class="flex gap-4">
              <div class="flex-1 relative">
                <textarea 
                  id="messageInput" 
                  placeholder="Type your message..." 
                  class="textarea"
                  rows="1"
                ></textarea>
                <button id="sendMessage" class="absolute right-2 inset-y-0 my-auto flex items-center justify-center w-10 h-10 transition-colors" style="color: #00A3E0;">
                  <i class="fas fa-paper-plane text-xl"></i>
                </button>
              </div>
              <div class="flex items-center">
                <button id="saveConversation" class="flex items-center gap-2 px-4 py-2 text-white rounded-lg transition-colors" style="background-color: #00A3E0;">
                  <i class="fas fa-folder-plus text-white"></i>
                  <span>Save to Topic</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Notes Panel -->
  <div id="notesPanel" class="fixed top-0 right-0 w-96 h-screen bg-white shadow-lg z-50 flex flex-col border-l border-gray-200 transform translate-x-full transition-transform duration-300 ease-in-out">
    <div class="flex justify-between items-center p-5 bg-gray-50 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
        <i class="fas fa-sticky-note text-yellow-400"></i> Quick Notes
      </h2>
      <button class="text-2xl text-gray-500 hover:text-gray-700 transition-colors" id="closeNotesBtn">&times;</button>
    </div>
    
    <div class="flex-1 flex flex-col overflow-hidden">
      <div class="p-5 border-b border-gray-200">
        <textarea id="noteText" placeholder="Jot down a thought..." class="w-full h-24 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400 focus:border-transparent resize-none transition-all duration-200 font-eb-garamond"></textarea>
        <div class="flex gap-3 mt-4">
          <select id="noteTopic" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400 focus:border-transparent text-sm">
            <option value="">Untagged</option>
            <!-- Topics will be loaded here -->
          </select>
          <button id="saveNote" class="bg-yellow-400 hover:bg-yellow-500 text-gray-800 px-4 py-2 rounded-lg transition-colors duration-200 flex items-center gap-2">
            <i class="fas fa-save"></i> Save
          </button>
        </div>
      </div>
      
      <div class="flex justify-between items-center p-4 border-b border-gray-200">
        <h3 class="font-medium text-gray-800">Saved Notes</h3>
        <select id="noteFilter" class="p-1.5 text-sm border border-gray-300 rounded-lg">
          <option value="all">All Notes</option>
          <option value="untagged">Untagged</option>
          <!-- Topics will be loaded here -->
        </select>
      </div>
      
      <div id="notesList" class="flex-1 overflow-y-auto p-4">
        <!-- Notes will be loaded here -->
      </div>
    </div>
  </div>

  <script>
    // Constants for styles and strings
    const STYLES = {
      PRIMARY_COLOR: '#00A3E0',
      SECONDARY_COLOR: '#6c757d',
      FONT_FAMILY: 'Arial, sans-serif'
    };
    const CLASS_NAMES = {
      ACTIVE: 'active',
      HIDDEN: 'hidden',
      LOADING: 'loading'
    };

    // Utility function for API calls
    async function makeApiCall(url, options) {
      try {
        const response = await fetch(url, options);
        if (!response.ok) throw new Error(`API call failed with status ${response.status}`);
        return await response.json();
      } catch (error) {
        console.error('API Error:', error);
        throw error;
      }
    }

    // Template for buttons
    function createButton(text, id, classes = '') {
      return `<button id="${id}" class="btn ${classes}">${text}</button>`;
    }

    // Template for modals
    function createModal(id, title, content) {
      return `
        <div id="${id}" class="modal ${CLASS_NAMES.HIDDEN}">
          <div class="modal-content">
            <h2>${title}</h2>
            ${content}
          </div>
        </div>
      `;
    }

    // Modular event listener setup
    function setupEventListeners() {
      setupNavigationListeners();
      setupNotesListeners();
      setupChatListeners();
    }

    function setupNavigationListeners() {
      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function() {
          // Handle navigation
          document.querySelectorAll('.nav-link').forEach(nav => nav.classList.remove(CLASS_NAMES.ACTIVE));
          this.classList.add(CLASS_NAMES.ACTIVE);
        });
      });
    }

    function setupNotesListeners() {
      document.getElementById('notesToggle')?.addEventListener('click', function() {
        // Toggle notes panel
        document.getElementById('notesPanel')?.classList.toggle(CLASS_NAMES.HIDDEN);
      });
    }

    function setupChatListeners() {
      document.getElementById('sendMessage')?.addEventListener('click', function() {
        // Send message logic
        const textarea = document.getElementById('messageInput');
        const message = textarea.value.trim();
        if (message) {
          // Process message
          textarea.value = '';
        }
      });
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      setupEventListeners();

      // Get user info from localStorage
      const userId = localStorage.getItem('userId');
      const accessToken = localStorage.getItem('accessToken');
      
      // Check if user is logged in
      function updateNavigation() {
        const loggedInNav = document.getElementById('loggedInNav');
        const loggedOutNav = document.getElementById('loggedOutNav');
        
        if (userId && accessToken) {
          loggedInNav.classList.remove(CLASS_NAMES.HIDDEN);
          loggedOutNav.classList.add(CLASS_NAMES.HIDDEN);
        } else {
          loggedInNav.classList.add(CLASS_NAMES.HIDDEN);
          loggedOutNav.classList.remove(CLASS_NAMES.HIDDEN);
          window.location.href = '/pages/login.html';
        }
      }
      
      // Initialize the page when DOM is loaded
      updateNavigation();
      
      // Mobile navigation
      const hamburger = document.getElementById('hamburger');
      const sidebar = document.getElementById('sidebar');
      const closeSidebar = document.getElementById('closeSidebar');
      
      if (hamburger && sidebar && closeSidebar) {
        hamburger.addEventListener('click', () => {
          sidebar.classList.toggle('translate-x-0');
        });
        
        closeSidebar.addEventListener('click', () => {
          sidebar.classList.remove('translate-x-0');
        });
      }
      
      // Logout functionality
      const logoutButton = document.getElementById('logout');
      if (logoutButton) {
        logoutButton.addEventListener('click', () => {
          localStorage.removeItem('userId');
          localStorage.removeItem('accessToken');
          window.location.href = '/pages/login.html';
        });
      }
      
      // Chat functionality
      const messageInput = document.getElementById('messageInput');
      const chatContainer = document.getElementById('chatContainer');
      const conversationType = document.getElementById('conversationType');
      const saveConversationBtn = document.getElementById('saveConversation');
      let conversationHistory = []; // Initialize conversation history

      // Auto-resize textarea
      if (messageInput) {
        messageInput.addEventListener('input', function() {
          this.style.height = 'auto';
          this.style.height = Math.min(this.scrollHeight, 128) + 'px';
        });
      }
      
      // Send message on Enter (without shift)
      if (messageInput) {
        messageInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
      }
      
      // Auto-scroll when new content is added to the chat container
      const chatObserver = new MutationObserver(() => {
        scrollToBottom();
      });
      
      // Start observing the chat container for added nodes
      if (chatContainer) {
        chatObserver.observe(chatContainer, { childList: true, subtree: true });
      }
      
      async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;
        
        // Add user message to history and chat
        conversationHistory.push({ role: 'user', content: message });
        addMessageToChat('user', message);
        
        // Clear input
        messageInput.value = '';
        messageInput.style.height = '48px';
        
        // Show empty state if it's the first message
        const emptyState = chatContainer.querySelector('.empty-state');
        if (emptyState) {
          emptyState.remove();
        }
        
        // Show loading state
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'flex justify-start';
        const avatarSrc = document.getElementById('chatSidebarUserAvatar')?.src || '../assets/avatars/default.png';
        
        loadingDiv.innerHTML = `
          <div class="bg-gray-100 rounded-lg p-3 flex items-center gap-2 max-w-[80%] typing-indicator">
            <img src="${avatarSrc}" alt="Koda" class="w-8 h-8 rounded-full object-cover" onerror="this.src='../assets/avatars/default.png'">
            <div class="flex flex-col">
              <span class="text-xs text-gray-500 mb-1">Koda is typing...</span>
              <div class="flex gap-1">
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
              </div>
            </div>
          </div>
        `;
        chatContainer.appendChild(loadingDiv);
        scrollToBottom();
        
        try {
          // Add the system prompt to the history before sending if it's the first user message
          if (conversationHistory.filter(m => m.role === 'user').length === 1) {
            conversationHistory.unshift({ 
              role: 'system', 
              content: 'You are Koda, a friendly and curious learning companion who\'s excited to explore topics with me! Your tone is warm, conversational, and upbeat—like a buddy who loves diving into new ideas. Avoid stiff or robotic replies; instead, show enthusiasm, ask me questions to keep the chat going, and make it feel like we\'re discovering together. Tailor your responses to my interests based on our conversations, bookmarks, or notes, and keep things simple and fun so I enjoy every moment!' 
            });
          }
          
          const response = await fetch('/.netlify/functions/chatgpt', {
            method: 'POST',
            body: JSON.stringify({ messages: conversationHistory }), // Send full history
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            }
          });
          
          // Remove loading state
          loadingDiv.remove();
          
          const result = await response.json();
          
          if (response.ok) {
            // Add AI response to history and chat
            conversationHistory.push({ role: 'assistant', content: result.assistantResponse });
            addMessageToChat('ai', result.assistantResponse);
          } else {
            showToast('Error: ' + (result.error || 'Failed to send message'), 'error');
          }
        } catch (error) {
          // Remove loading state
          loadingDiv.remove();
          console.error('Error sending message:', error);
          showToast('Error connecting to server', 'error');
        }
      }
      
      // Function to scroll chat to bottom smoothly
      function scrollToBottom() {
        if (chatContainer) {
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }
      }

      function addMessageToChat(type, content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex ${type === 'user' ? 'justify-end' : 'justify-start'} opacity-0 transform translate-y-4 transition-all duration-300`;
        
        // For AI messages, add the avatar
        if (type === 'ai') {
          const avatarContainer = document.createElement('div');
          avatarContainer.className = 'flex-shrink-0 mr-2 self-end';
          
          // Get avatar from sidebar to ensure consistency
          const avatar = document.createElement('img');
          avatar.src = document.getElementById('chatSidebarUserAvatar')?.src || '../assets/avatars/default.png';
          avatar.alt = 'Koda';
          avatar.className = 'w-8 h-8 rounded-full object-cover';
          avatar.onerror = function() { this.src = '../assets/avatars/default.png'; };
          
          avatarContainer.appendChild(avatar);
          messageDiv.appendChild(avatarContainer);
        }
        
        const messageBubble = document.createElement('div');
        messageBubble.className = type === 'user' 
          ? 'bg-green-500 text-white rounded-lg py-2 px-4 max-w-[80%] shadow-sm'
          : 'bg-gray-100 text-gray-800 rounded-lg py-2 px-4 max-w-[80%] shadow-sm';
        
        // Parse markdown to HTML and display
        if (typeof content === 'string') {
          messageBubble.innerHTML = marked.parse(content);
        } else {
          messageBubble.textContent = ''; // Or some default error message
          console.warn('Received non-string content for AI message:', content);
        }
        
        messageDiv.appendChild(messageBubble);
        
        chatContainer.appendChild(messageDiv);
        
        // Scroll to bottom after adding the message
        scrollToBottom();
        
        // Animate the message in
        requestAnimationFrame(() => {
          messageDiv.classList.remove('opacity-0', 'translate-y-4');
          // Scroll again after animation to ensure visibility
          setTimeout(scrollToBottom, 100);
        });
      }
      
      // Initialize empty state
      if (chatContainer && chatContainer.children.length === 0) {
        chatContainer.innerHTML = `
          <div class="empty-state flex flex-col items-center justify-center h-full text-gray-500">
            <i class="fas fa-comments text-4xl mb-4"></i>
            <div class="greeting-container py-3 px-6 rounded-lg mb-4">
              <h2 id="greeting-message" class="text-2xl font-semibold text-gray-800 mb-2">Good Evening!</h2>
              <p class="text-center mb-2 text-gray-600">How can I help you today?</p>
            </div>
            <div class="flex flex-wrap gap-2 justify-center max-w-lg">
              <button class="suggested-question px-4 py-2 bg-white text-gray-700 rounded-full border transition-all duration-200 text-sm">
                What are IOPoints?
              </button>
              <button class="suggested-question px-4 py-2 bg-white text-gray-700 rounded-full border transition-all duration-200 text-sm">
                Who is John Galt?
              </button>
              <button class="suggested-question px-4 py-2 bg-white text-gray-700 rounded-full border transition-all duration-200 text-sm">
                Why do bees fly?
              </button>
            </div>
          </div>
        `;
        
        // Set greeting based on time of day
        updateGreeting();
        
        // Add event listeners to suggested questions
        document.querySelectorAll('.suggested-question').forEach(button => {
          button.addEventListener('click', function() {
            messageInput.value = this.textContent.trim();
            messageInput.focus();
          });
          
          // CSS handles hover effects now through the .suggested-question:hover style
        });
      }
      
      // Save conversation
      if (saveConversationBtn) {
        saveConversationBtn.addEventListener('click', async () => {
          // Create a select element for topics
          const topicSelect = document.createElement('select');
          topicSelect.className = 'w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-transparent mb-4';
          
          // Show loading state
          const loadingDiv = document.createElement('div');
          loadingDiv.className = 'flex justify-center items-center';
          loadingDiv.innerHTML = `
            <div class="animate-spin rounded-full h-5 w-5 border-2 border-green-500 border-t-transparent"></div>
          `;
          
          // Create modal content
          const modalContent = document.createElement('div');
          modalContent.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
          modalContent.innerHTML = `
            <div class="bg-white rounded-lg p-6 w-full max-w-md shadow-lg">
              <h3 class="text-lg font-semibold text-gray-800 mb-4">Save Conversation to Topic</h3>
              <div id="topicSelectContainer" class="mb-4">
                ${loadingDiv.outerHTML}
              </div>
              <div class="flex justify-end gap-3 mt-4">
                <button class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors" id="cancelSave">Cancel</button>
                <button class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-medium rounded-lg transition-colors shadow" id="confirmSave">Save to Topic</button>
              </div>
            </div>
          `;
          
          // Add direct handler for the cancel button to ensure it works
          modalContent.addEventListener('click', (e) => {
            if (e.target === modalContent) {
              modalContent.remove();
            }
          });
          
          document.body.appendChild(modalContent);
          
          // Load topics
          try {
            const response = await fetch('/.netlify/functions/dashboard', {
              method: 'POST',
              body: JSON.stringify({
                action: 'getTopics',
                userId
              }),
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`
              }
            });
            
            const result = await response.json();
            
            if (response.ok && result.topics) {
              const selectContainer = modalContent.querySelector('#topicSelectContainer');
              selectContainer.innerHTML = '';
              
              if (result.topics.length === 0) {
                selectContainer.innerHTML = `
                  <div class="text-center text-gray-600">
                    <p class="mb-2">No topics found.</p>
                    <a href="settings.html" class="text-green-500 hover:text-green-600 transition-colors">Create a topic first</a>
                  </div>
                `;
                return;
              }
              
              topicSelect.innerHTML = result.topics.map(topic => 
                `<option value="${topic.id}">${topic.name}</option>`
              ).join('') + `<option value="new_topic">+ Create New Topic</option>`;
              
              selectContainer.appendChild(topicSelect);
              // Make sure topic select is visible
              topicSelect.style.display = 'block';
              
              // Add new topic input field (hidden by default)
              const newTopicInput = document.createElement('input');
              newTopicInput.type = 'text';
              newTopicInput.id = 'newTopicInput';
              newTopicInput.className = 'w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-transparent mt-2';
              newTopicInput.placeholder = 'Enter new topic name...';
              newTopicInput.style.display = 'none';
              selectContainer.appendChild(newTopicInput);
              
              // Show/hide new topic input based on selection
              topicSelect.addEventListener('change', function() {
                if (this.value === 'new_topic') {
                  newTopicInput.style.display = 'block';
                  newTopicInput.focus();
                } else {
                  newTopicInput.style.display = 'none';
                }
              });
              
              // Handle save confirmation
              const confirmBtn = modalContent.querySelector('#confirmSave');
              // Ensure button is visible
              confirmBtn.style.display = 'block';
              
              // Ensure Save to Topic button is prominent
              confirmBtn.style.fontWeight = 'bold';
              confirmBtn.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
              confirmBtn.addEventListener('click', async () => {
                const selectedTopicId = topicSelect.value;
                let finalTopicId = selectedTopicId;
                
                try {
                  // If "Create New Topic" is selected, create a new topic first
                  if (selectedTopicId === 'new_topic') {
                    const newTopicName = document.getElementById('newTopicInput').value.trim();
                    
                    if (!newTopicName) {
                      showToast('Please enter a topic name', 'error');
                      return;
                    }
                    
                    // Create loading indicator
                    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
                    confirmBtn.disabled = true;
                    
                    // Create the new topic
                    const createTopicResponse = await fetch('/.netlify/functions/dashboard', {
                      method: 'POST',
                      body: JSON.stringify({
                        action: 'addTopic',
                        userId,
                        topicName: newTopicName
                      }),
                      headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                      }
                    });
                    
                    const createTopicResult = await createTopicResponse.json();
                    
                    if (!createTopicResponse.ok) {
                      showToast('Error: ' + (createTopicResult.error || 'Failed to create topic'), 'error');
                      confirmBtn.innerHTML = 'Save';
                      confirmBtn.disabled = false;
                      return;
                    }
                    
                    finalTopicId = createTopicResult.topicId;
                    confirmBtn.innerHTML = 'Save';
                  }
                  
                  // Now save the conversation with the topic ID (either existing or newly created)
                  const saveResponse = await fetch('/.netlify/functions/chatgpt', {
                    method: 'POST',
                    body: JSON.stringify({
                      action: 'saveConversation',
                      userId,
                      topicId: finalTopicId,
                      messages: conversationHistory
                    }),
                    headers: {
                      'Content-Type': 'application/json',
                      'Authorization': `Bearer ${accessToken}`
                    }
                  });
                  
                  const saveResult = await saveResponse.json();
                  
                  if (saveResponse.ok) {
                    showToast('Conversation saved successfully', 'success');
                  } else {
                    showToast('Error: ' + (saveResult.error || 'Failed to save conversation'), 'error');
                  }
                } catch (error) {
                  console.error('Error saving conversation:', error);
                  showToast('Error connecting to server', 'error');
                }
                
                modalContent.remove();
              });
              
              // Handle cancel
              const cancelBtn = modalContent.querySelector('#cancelSave');
              cancelBtn.addEventListener('click', () => {
                modalContent.remove();
              });
            }
          } catch (error) {
            console.error('Error loading topics:', error);
            showToast('Error loading topics', 'error');
            modalContent.remove();
          }
        });
      }
      
      // Notes functionality
      const notesToggle = document.getElementById('notesToggle');
      const notesPanel = document.getElementById('notesPanel');
      const closeNotes = document.getElementById('closeNotesBtn');
      
      if (notesToggle && notesPanel && closeNotes) {
        notesToggle.addEventListener('click', (e) => {
          e.preventDefault();
          notesPanel.classList.toggle(CLASS_NAMES.HIDDEN);
          if (!notesPanel.classList.contains(CLASS_NAMES.HIDDEN)) {
            loadNotesTopics();
            loadNotes();
          }
        });
        
        closeNotes.addEventListener('click', () => {
          notesPanel.classList.toggle(CLASS_NAMES.HIDDEN);
        });
      }
      
      // Load topics for notes
      async function loadNotesTopics() {
        const topicSelect = document.getElementById('noteTopic');
        const filterSelect = document.getElementById('noteFilter');
        
        try {
          const response = await fetch('/.netlify/functions/dashboard', {
            method: 'POST',
            body: JSON.stringify({
              action: 'getTopics',
              userId
            }),
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            }
          });
          
          const result = await response.json();
          
          if (response.ok && result.topics) {
            const topicOptions = result.topics.map(topic => 
              `<option value="${topic.id}">${topic.name}</option>`
            ).join('');
            
            topicSelect.innerHTML = `
              <option value="">Untagged</option>
              ${topicOptions}
            `;
            
            filterSelect.innerHTML = `
              <option value="all">All Notes</option>
              <option value="untagged">Untagged</option>
              ${topicOptions}
            `;
          }
        } catch (error) {
          console.error('Error loading topics:', error);
        }
      }
      
      // Save note
      const saveNoteBtn = document.getElementById('saveNote');
      const noteTextarea = document.getElementById('noteText');
      const noteTopicSelect = document.getElementById('noteTopic');
      
      if (saveNoteBtn) {
        saveNoteBtn.addEventListener('click', async () => {
          const content = noteTextarea.value.trim();
          if (!content) return;
          
          const originalButtonText = saveNoteBtn.innerHTML;
          saveNoteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
          saveNoteBtn.disabled = true;
          
          try {
            const response = await fetch('/.netlify/functions/dashboard', {
              method: 'POST',
              body: JSON.stringify({
                action: 'saveNote',
                userId,
                content,
                topicId: noteTopicSelect.value || null
              }),
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`
              }
            });
            
            const result = await response.json();
            
            if (response.ok) {
              noteTextarea.value = '';
              loadNotes();
              showToast('Note saved successfully', 'success');
            } else {
              showToast('Error saving note: ' + result.error, 'error');
            }
          } catch (error) {
            console.error('Error saving note:', error);
            showToast('Error connecting to server', 'error');
          } finally {
            saveNoteBtn.innerHTML = originalButtonText;
            saveNoteBtn.disabled = false;
          }
        });
      }
      
      // Load notes
      const noteFilter = document.getElementById('noteFilter');
      
      if (noteFilter) {
        noteFilter.addEventListener('change', loadNotes);
      }
      
      async function loadNotes() {
        const notesList = document.getElementById('notesList');
        const filterValue = noteFilter.value;
        
        notesList.innerHTML = `
          <div class="flex justify-center items-center h-32">
            <div class="animate-spin rounded-full h-8 w-8 border-2 border-yellow-400 border-t-transparent"></div>
          </div>
        `;
        
        try {
          const response = await fetch('/.netlify/functions/dashboard', {
            method: 'POST',
            body: JSON.stringify({
              action: 'getNotes',
              userId,
              topicId: filterValue === 'all' ? null : (filterValue === 'untagged' ? 'untagged' : filterValue)
            }),
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            }
          });
          
          const result = await response.json();
          
          if (response.ok) {
            notesList.innerHTML = '';
            
            if (result.notes && result.notes.length > 0) {
              result.notes.forEach(note => {
                const noteItem = document.createElement('div');
                noteItem.className = 'bg-yellow-50 border-l-4 border-yellow-400 rounded-lg p-4 mb-4 relative group';
                
                const date = new Date(note.created_at);
                const formattedDate = `${date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}`;
                
                noteItem.innerHTML = `
                  <p class="text-gray-800 mb-3">${note.content}</p>
                  <div class="flex justify-between items-center text-sm">
                    <span class="bg-gray-100 px-2 py-1 rounded text-gray-600">${note.topic_name || 'Untagged'}</span>
                    <span class="text-gray-500">${formattedDate}</span>
                  </div>
                  <button class="delete-note absolute top-2 right-2 text-red-500 opacity-0 group-hover:opacity-100 transition-opacity duration-200" data-note-id="${note.id}">
                    <i class="fas fa-trash"></i>
                  </button>
                `;
                
                notesList.appendChild(noteItem);
              });
              
              // Add event listeners for delete buttons
              document.querySelectorAll('.delete-note').forEach(button => {
                button.addEventListener('click', async (e) => {
                  const noteId = e.currentTarget.dataset.noteId;
                  await deleteNote(noteId);
                });
              });
            } else {
              notesList.innerHTML = `
                <div class="flex flex-col items-center justify-center h-32 text-gray-500">
                  <i class="fas fa-sticky-note text-2xl mb-2"></i>
                  <p>No notes found</p>
                </div>
              `;
            }
          } else {
            notesList.innerHTML = `
              <div class="flex flex-col items-center justify-center h-32 text-red-500">
                <p>Failed to load notes: ${result.error || 'Unknown error'}</p>
              </div>
            `;
          }
        } catch (error) {
          console.error('Error loading notes:', error);
          notesList.innerHTML = `
            <div class="flex flex-col items-center justify-center h-32 text-red-500">
              <p>Error connecting to server. Please try again.</p>
            </div>
          `;
        }
      }
      
      // Delete note
      async function deleteNote(noteId) {
        if (!confirm('Are you sure you want to delete this note?')) return;
        
        try {
          const response = await fetch('/.netlify/functions/dashboard', {
            method: 'POST',
            body: JSON.stringify({
              action: 'deleteNote',
              userId,
              noteId
            }),
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            }
          });
          
          const result = await response.json();
          
          if (response.ok) {
            loadNotes();
            showToast('Note deleted successfully', 'success');
          } else {
            showToast('Error deleting note: ' + (result.error || 'Unknown error'), 'error');
          }
        } catch (error) {
          console.error('Error deleting note:', error);
          showToast('Error connecting to server. Please try again.', 'error');
        }
      }
      
      // Update greeting based on time of day
      function updateGreeting() {
        const greetingElement = document.getElementById('greeting-message');
        if (!greetingElement) return;
        
        const hour = new Date().getHours();
        let greeting = 'Good ';
        
        if (hour < 12) {
          greeting += 'Morning!';
        } else if (hour < 18) {
          greeting += 'Afternoon!';
        } else {
          greeting += 'Evening!';
        }
        
        greetingElement.textContent = greeting;
      }
      
      // Function to load avatar from localStorage or backend
      async function loadTutorAvatar() {
        try {
          const userId = localStorage.getItem('userId');
          const accessToken = localStorage.getItem('accessToken');
          const chatSidebarUserAvatar = document.getElementById('chatSidebarUserAvatar');
          const chatAvatarLoading = document.getElementById('chatAvatarLoading');
          
          // Check for cached avatar URL first
          const cachedAvatarUrl = localStorage.getItem('userAvatarUrl');

          if (!userId || !accessToken) {
            console.warn('No user ID or access token found for avatar fetch');
            showDefaultAvatar(chatSidebarUserAvatar, chatAvatarLoading);
            return;
          }
          
          // Use cached avatar if available (prevents flashing)
          if (cachedAvatarUrl) {
            chatSidebarUserAvatar.src = cachedAvatarUrl;
            chatSidebarUserAvatar.onload = () => {
              chatSidebarUserAvatar.classList.remove('opacity-0');
              chatSidebarUserAvatar.classList.add('opacity-100');
              if (chatAvatarLoading) chatAvatarLoading.style.display = 'none';
            };
          }

          // Fetch avatar from database
          const response = await fetch('/.netlify/functions/dashboard', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({
              action: 'getAvatar',
              userId: userId
            })
          });

          const result = await response.json();

          if (response.ok && result.avatarUrl) {
            // Cache the avatar URL
            localStorage.setItem('userAvatarUrl', result.avatarUrl);
            
            // Update sidebar avatar if it's different
            if (chatSidebarUserAvatar) {
              if (chatSidebarUserAvatar.src !== result.avatarUrl) {
                chatSidebarUserAvatar.src = result.avatarUrl;
                chatSidebarUserAvatar.onload = () => {
                  chatSidebarUserAvatar.classList.remove('opacity-0');
                  chatSidebarUserAvatar.classList.add('opacity-100');
                  if (chatAvatarLoading) chatAvatarLoading.style.display = 'none';
                };
              } else if (chatSidebarUserAvatar.classList.contains('opacity-0')) {
                // In case the image was already loaded but not made visible
                chatSidebarUserAvatar.classList.remove('opacity-0');
                chatSidebarUserAvatar.classList.add('opacity-100');
                if (chatAvatarLoading) chatAvatarLoading.style.display = 'none';
              }
              console.log('Avatar loaded from database:', result.avatarUrl);
            } else {
              console.warn('User avatar element not found');
            }
          } else {
            console.warn('Avatar fetch returned no URL or error:', result);
            // Only show default if no cached avatar already displayed
            if (!cachedAvatarUrl && chatSidebarUserAvatar) {
              showDefaultAvatar(chatSidebarUserAvatar, chatAvatarLoading);
            }
          }
        } catch (error) {
          console.error('Error loading user avatar from database:', error);
          const chatSidebarUserAvatar = document.getElementById('chatSidebarUserAvatar');
          const chatAvatarLoading = document.getElementById('chatAvatarLoading');
          // Only show default if no cached avatar
          if (!localStorage.getItem('userAvatarUrl') && chatSidebarUserAvatar) {
            showDefaultAvatar(chatSidebarUserAvatar, chatAvatarLoading);
          }
        }
      }

      // Helper function to display default avatar
      function showDefaultAvatar(imgElement, loadingElement) {
        if (!imgElement) return;
        
        imgElement.src = '../assets/avatars/default.png';
        imgElement.onload = () => {
          imgElement.classList.remove('opacity-0');
          imgElement.classList.add('opacity-100');
          if (loadingElement) loadingElement.style.display = 'none';
        };
      }
      
      // Call loadTutorAvatar on page load
      window.addEventListener('load', loadTutorAvatar);
    });
  </script>
</body>
</html>
