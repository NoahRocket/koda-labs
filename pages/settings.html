<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - Koda Compass</title>
  <link rel="stylesheet" href="../styles/main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="../scripts/utils.js" defer></script>
</head>
<body class="bg-gray-50 font-eb-garamond min-h-screen flex">
  <!-- Mobile Hamburger -->
  <div class="md:hidden fixed top-4 left-4 z-50 cursor-pointer p-2 mobile-touch-target" id="hamburger">
    <div class="w-6 h-0.5 bg-gray-800 mb-1"></div>
    <div class="w-6 h-0.5 bg-gray-800 mb-1"></div>
    <div class="w-6 h-0.5 bg-gray-800"></div>
  </div>

  <!-- Sidebar Navigation -->
  <div id="sidebar" class="fixed top-0 left-0 h-screen w-56 bg-blue-50 shadow-md transform md:translate-x-0 transition-transform duration-300 z-40">
    <div class="flex flex-col h-full">
      <div class="p-5 border-b border-blue-100">
        <h1 class="text-xl font-bold text-gray-800">Koda Compass</h1>
        <button id="closeSidebar" class="absolute top-5 right-4 text-gray-500 hover:text-gray-700 md:hidden mobile-touch-target">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <nav class="flex-1 overflow-y-auto py-4">
        <ul class="space-y-2 px-4">
          <li id="loggedInNav" class="hidden flex-col space-y-2">
            <a href="dashboard.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-blue-100 hover:text-blue-800 transition-colors mobile-touch-target">
              <i class="fas fa-compass"></i>
              <span class="mobile-readable">Dashboard</span>
            </a>
            <a href="chat.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-blue-100 hover:text-blue-800 transition-colors mobile-touch-target">
              <i class="fas fa-comments"></i>
              <span class="mobile-readable">Chat</span>
            </a>
            <a href="bookmarks.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-blue-100 hover:text-blue-800 transition-colors mobile-touch-target">
              <i class="fas fa-bookmark"></i>
              <span class="mobile-readable">Bookmarks</span>
            </a>
            <a href="#" id="notesToggle" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-blue-100 hover:text-blue-800 transition-colors mobile-touch-target">
              <i class="fas fa-sticky-note"></i>
              <span class="mobile-readable">Notes</span>
            </a>
            <a href="podcasts.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-blue-100 hover:text-blue-800 transition-colors mobile-touch-target">
              <i class="fas fa-podcast"></i>
              <span class="mobile-readable">Podcasts</span>
            </a>
            <a href="settings.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg bg-blue-100 text-blue-800 mobile-touch-target">
              <i class="fas fa-cog"></i>
              <span class="mobile-readable">Settings</span>
            </a>
          </li>
          <li id="loggedOutNav" class="hidden flex-col space-y-2">
            <a href="login.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-blue-100 hover:text-blue-800 transition-colors">
              <i class="fas fa-sign-in-alt"></i>
              <span>Login</span>
            </a>
            <a href="signup.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-blue-100 hover:text-blue-800 transition-colors">
              <i class="fas fa-user-plus"></i>
              <span>Sign Up</span>
            </a>
          </li>
        </ul>
      </nav>
      
      <div class="p-4 border-t border-blue-100">
        <button id="logout" class="w-full flex items-center justify-center space-x-2 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </button>
      </div>
    </div>
  </div>

  <main class="md:ml-56 flex-1 p-8">
    <h1 class="text-3xl font-bold mb-8 text-gray-800">Settings</h1>
    
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
      <h2 class="text-xl font-semibold mb-4 text-gray-700">Topic Management</h2>
      <div class="flex justify-between items-center bg-gray-50 p-4 rounded-lg">
        <div>
          <div class="font-medium text-gray-800">Manage Topics</div>
          <div class="text-sm text-gray-600 mt-1">Create, edit, or delete your conversation topics</div>
        </div>
        <button id="manageTopicsBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md transition-colors duration-200 flex items-center">
          <i class="fas fa-cog mr-2"></i> Manage
        </button>
      </div>
      <div class="topic-management hidden mt-6" id="topicManagement">
        <div class="flex gap-4 mb-4">
          <input type="text" id="newTopicInput" placeholder="Enter new topic name" class="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <button id="addTopicBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md transition-colors duration-200">Add Topic</button>
        </div>
        <div class="topic-list" id="topicList">
          <!-- Topics will be loaded here -->
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
      <h2 class="text-xl font-semibold mb-4 text-gray-700">Account Settings</h2>
      <div class="flex justify-between items-center bg-gray-50 p-4 rounded-lg mb-4">
        <div>
          <div class="font-medium text-gray-800">Change Password</div>
          <div class="text-sm text-gray-600 mt-1">Update your account password</div>
        </div>
        <button id="changePassword" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md transition-colors duration-200 flex items-center">
          <i class="fas fa-key mr-2"></i> Update
        </button>
      </div>
      <div class="flex justify-between items-center bg-gray-50 p-4 rounded-lg">
        <div>
          <div class="font-medium text-gray-800">Delete Account</div>
          <div class="text-sm text-gray-600 mt-1">Permanently delete your account and all associated data</div>
        </div>
        <button id="deleteAccount" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md transition-colors duration-200 flex items-center">
          <i class="fas fa-trash mr-2"></i> Delete
        </button>
      </div>
    </div>
  </main>

  <script>
    // Get user info from localStorage
    const userId = localStorage.getItem('userId');
    const accessToken = localStorage.getItem('accessToken');
    
    // Check if user is logged in
    function updateNavigation() {
      const loggedInNav = document.getElementById('loggedInNav');
      const loggedOutNav = document.getElementById('loggedOutNav');
      
      if (userId && accessToken) {
        loggedInNav.classList.remove('hidden');
        loggedOutNav.classList.add('hidden');
      } else {
        loggedInNav.classList.add('hidden');
        loggedOutNav.classList.remove('hidden');
        window.location.href = '/pages/login.html';
      }
    }

    // Initialize the page when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Call updateNavigation on page load
      updateNavigation();

      // Mobile navigation
      const hamburger = document.getElementById('hamburger');
      const sidebar = document.getElementById('sidebar');
      const closeSidebar = document.getElementById('closeSidebar');
      
      if (hamburger && sidebar && closeSidebar) {
        hamburger.addEventListener('click', () => {
          sidebar.classList.remove('-translate-x-full');
        });
        
        closeSidebar.addEventListener('click', () => {
          sidebar.classList.add('-translate-x-full');
        });
      }

      // Topic Management
      const manageTopicsBtn = document.getElementById('manageTopicsBtn');
      if (manageTopicsBtn) {
        manageTopicsBtn.addEventListener('click', () => {
          const topicManagement = document.getElementById('topicManagement');
          topicManagement.classList.toggle('hidden');
          if (!topicManagement.classList.contains('hidden')) {
            loadTopics();
          }
        });
      }

      // Add Topic Button
      const addTopicBtn = document.getElementById('addTopicBtn');
      if (addTopicBtn) {
        addTopicBtn.addEventListener('click', async () => {
          const input = document.getElementById('newTopicInput');
          const topicName = input.value.trim();
          
          if (!topicName) {
            alert('Please enter a topic name');
            return;
          }

          try {
            const response = await fetch('/.netlify/functions/dashboard', {
              method: 'POST',
              body: JSON.stringify({ 
                action: 'addTopic',
                userId,
                topicName 
              }),
              headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`
              }
            });

            if (!response.ok) {
              throw new Error('Failed to add topic');
            }

            input.value = ''; // Clear the input
            loadTopics(); // Reload the topics list
            showToast('Topic added successfully!', 'success');
          } catch (error) {
            console.error('Error adding topic:', error);
            showToast('Failed to add topic. Please try again.', 'error');
          }
        });
      }

      // Change Password
      const changePasswordBtn = document.getElementById('changePassword');
      if (changePasswordBtn) {
        changePasswordBtn.addEventListener('click', () => {
          // Will implement password change functionality
          alert('Password change feature coming soon!');
        });
      }

      // Delete Account
      const deleteAccountBtn = document.getElementById('deleteAccount');
      if (deleteAccountBtn) {
        deleteAccountBtn.addEventListener('click', () => {
          if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
            // Will implement account deletion functionality
            alert('Account deletion feature coming soon!');
          }
        });
      }

      // Logout
      const logoutBtn = document.getElementById('logout');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
          localStorage.removeItem('userId');
          localStorage.removeItem('accessToken');
          window.location.href = '/';
        });
      }

      // Initial loads
      loadNotes();
    });

    async function loadTopics() {
      const topicList = document.getElementById('topicList');
      if (!topicList) return;
      
      topicList.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-blue-500 text-xl"></i></div>';
      
      try {
        const response = await fetch('/.netlify/functions/dashboard', {
          method: 'POST',
          body: JSON.stringify({
            action: 'getTopics',
            userId
          }),
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          }
        });
        
        const result = await response.json();
        
        if (response.ok) {
          if (result.topics && result.topics.length > 0) {
            topicList.innerHTML = '';
            
            result.topics.forEach(topic => {
              const topicItem = document.createElement('div');
              topicItem.className = 'flex justify-between items-center bg-white p-4 rounded-lg shadow-sm mb-2';
              topicItem.dataset.id = topic.id;
              
              topicItem.innerHTML = `
                <div class="topic-name-display">
                  <span class="topic-name font-medium text-gray-800">${topic.name}</span>
                </div>
                <div class="flex items-center gap-2">
                  <button class="edit-topic-btn bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded transition-colors duration-200 text-sm">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="delete-topic-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded transition-colors duration-200 text-sm">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              `;
              
              topicList.appendChild(topicItem);
              
              // Edit button
              const editBtn = topicItem.querySelector('.edit-topic-btn');
              editBtn.addEventListener('click', () => {
                const nameDisplay = topicItem.querySelector('.topic-name-display');
                const currentName = topicItem.querySelector('.topic-name').textContent;
                
                nameDisplay.innerHTML = `
                  <input type="text" class="edit-topic-input px-3 py-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" value="${currentName}">
                  <div class="flex mt-2 gap-2">
                    <button class="save-topic-btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded transition-colors duration-200 text-sm">Save</button>
                    <button class="cancel-topic-btn bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded transition-colors duration-200 text-sm">Cancel</button>
                  </div>
                `;
                
                const saveBtn = topicItem.querySelector('.save-topic-btn');
                const cancelBtn = topicItem.querySelector('.cancel-topic-btn');
                const input = topicItem.querySelector('.edit-topic-input');
                
                // Focus the input
                input.focus();
                
                // Save button
                saveBtn.addEventListener('click', async () => {
                  const newName = input.value.trim();
                  if (!newName) return;
                  
                  try {
                    const response = await fetch('/.netlify/functions/dashboard', {
                      method: 'POST',
                      body: JSON.stringify({
                        action: 'updateTopic',
                        userId,
                        topicId: topic.id,
                        name: newName
                      }),
                      headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                      }
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                      nameDisplay.innerHTML = `<span class="topic-name font-medium text-gray-800">${newName}</span>`;
                      showToast('Topic updated successfully', 'success');
                    } else {
                      showToast('Failed to update topic: ' + (result.error || 'Unknown error'), 'error');
                    }
                  } catch (error) {
                    console.error('Error updating topic:', error);
                    showToast('Error connecting to server. Please try again.', 'error');
                  }
                });
                
                // Cancel button
                cancelBtn.addEventListener('click', () => {
                  nameDisplay.innerHTML = `<span class="topic-name font-medium text-gray-800">${currentName}</span>`;
                });
              });
              
              // Delete button
              const deleteBtn = topicItem.querySelector('.delete-topic-btn');
              deleteBtn.addEventListener('click', async () => {
                if (!confirm(`Are you sure you want to delete "${topic.name}"?`)) return;
                
                try {
                  const response = await fetch('/.netlify/functions/dashboard', {
                    method: 'POST',
                    body: JSON.stringify({
                      action: 'deleteTopic',
                      userId,
                      topicId: topic.id
                    }),
                    headers: {
                      'Content-Type': 'application/json',
                      'Authorization': `Bearer ${accessToken}`
                    }
                  });
                  
                  const result = await response.json();
                  
                  if (response.ok) {
                    topicItem.remove();
                    showToast('Topic deleted successfully', 'success');
                  } else {
                    showToast('Failed to delete topic: ' + (result.error || 'Unknown error'), 'error');
                  }
                } catch (error) {
                  console.error('Error deleting topic:', error);
                  showToast('Error connecting to server. Please try again.', 'error');
                }
              });
            });
          } else {
            topicList.innerHTML = '<div class="text-center py-4 text-gray-500">No topics found. Add your first topic above.</div>';
          }
        } else {
          topicList.innerHTML = `<div class="text-center py-4 text-red-500">Failed to load topics: ${result.error || 'Unknown error'}</div>`;
        }
      } catch (error) {
        console.error('Error loading topics:', error);
        topicList.innerHTML = '<div class="text-center py-4 text-red-500">Error connecting to server. Please try again.</div>';
      }
    }

    // Helper function to validate email format
    function isValidEmail(email) {
      const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      return emailRegex.test(email);
    }

    // Notes toggle functionality
    document.addEventListener('DOMContentLoaded', () => {
      // Set up notes toggle functionality
      const notesToggle = document.getElementById('notesToggle');
      const notesPanel = document.getElementById('notesPanel');
      const closeNotes = document.getElementById('closeNotesBtn');
      
      if (notesToggle && notesPanel && closeNotes) {
        notesToggle.addEventListener('click', (e) => {
          e.preventDefault();
          notesPanel.classList.toggle('active');
          if (notesPanel.classList.contains('active')) {
            loadNotesTopics();
            loadNotes();
          }
        });
        
        closeNotes.addEventListener('click', () => {
          notesPanel.classList.toggle('translate-x-full');
          if (!notesPanel.classList.contains('translate-x-full')) {
            loadNotesTopics();
            loadNotes();
          }
        });
      }
      
      // Set up save note functionality
      const saveNoteBtn = document.getElementById('saveNote');
      if (saveNoteBtn) {
        saveNoteBtn.addEventListener('click', saveNote);
      }
      
      // Set up note filter change event
      const noteFilter = document.getElementById('noteFilter');
      if (noteFilter) {
        noteFilter.addEventListener('change', loadNotes);
      }
    });
    
    // Load topics for notes dropdown
    async function loadNotesTopics() {
      const userId = localStorage.getItem('userId');
      const accessToken = localStorage.getItem('accessToken');
      
      try {
        const noteTopicSelect = document.getElementById('noteTopic');
        const noteFilterSelect = document.getElementById('noteFilter');
        
        // Don't overwrite initial options
        const defaultNoteTopicOption = noteTopicSelect.options[0];
        const defaultFilterOptions = Array.from(noteFilterSelect.options).slice(0, 2); // Keep "All" and "Untagged"
        
        // Show loading state
        noteTopicSelect.innerHTML = '';
        noteTopicSelect.appendChild(defaultNoteTopicOption);
        noteTopicSelect.disabled = true;
        
        noteFilterSelect.innerHTML = '';
        defaultFilterOptions.forEach(option => noteFilterSelect.appendChild(option));
        noteFilterSelect.disabled = true;
        
        const response = await fetch('/.netlify/functions/dashboard', {
          method: 'POST',
          body: JSON.stringify({
            action: 'getTopics',
            userId
          }),
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          }
        });
        
        const result = await response.json();
        
        // Re-enable selects
        noteTopicSelect.disabled = false;
        noteFilterSelect.disabled = false;
        
        if (response.ok && result.topics && result.topics.length > 0) {
          // Add topics to the note select
          result.topics.forEach(topic => {
            // Add to noteTopic select
            const topicOption = document.createElement('option');
            topicOption.value = topic.id;
            topicOption.textContent = topic.name;
            noteTopicSelect.appendChild(topicOption);
            
            // Add to filter select
            const filterOption = document.createElement('option');
            filterOption.value = topic.id;
            filterOption.textContent = topic.name;
            noteFilterSelect.appendChild(filterOption);
          });
        }
      } catch (error) {
        console.error('Error loading topics for notes:', error);
        showToast('Error loading topics. Please try again.', 'error');
      }
    }
    
    // Save a new note
    async function saveNote() {
      const noteText = document.getElementById('noteText').value.trim();
      const topicId = document.getElementById('noteTopic').value;
      const saveButton = document.getElementById('saveNote');
      
      if (!noteText) {
        // Animate textarea to show error
        const textarea = document.getElementById('noteText');
        textarea.classList.add('animate-shake');
        setTimeout(() => textarea.classList.remove('animate-shake'), 500);
        return;
      }
      
      // Show loading state
      const originalButtonText = saveButton.innerHTML;
      saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
      saveButton.disabled = true;
      
      const userId = localStorage.getItem('userId');
      const accessToken = localStorage.getItem('accessToken');
      
      try {
        const response = await fetch('/.netlify/functions/dashboard', {
          method: 'POST',
          body: JSON.stringify({
            action: 'saveNote',
            userId,
            content: noteText,
            topicId: topicId || null // Handle untagged case
          }),
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          }
        });
        
        const result = await response.json();
        
        if (response.ok) {
          // Show success state
          saveButton.innerHTML = '<i class="fas fa-check"></i> Saved!';
          saveButton.classList.add('success');
          
          // Clear input
          document.getElementById('noteText').value = '';
          
          // Reset button after delay
          setTimeout(() => {
            saveButton.innerHTML = originalButtonText;
            saveButton.classList.remove('success');
            saveButton.disabled = false;
          }, 1500);
          
          // Reload notes list
          loadNotes();
          
          // Show success toast
          showToast('Note saved successfully!', 'success');
        } else {
          // Show error state
          saveButton.innerHTML = originalButtonText;
          saveButton.disabled = false;
          
          showToast('Error saving note: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        console.error('Error saving note:', error);
        saveButton.innerHTML = originalButtonText;
        saveButton.disabled = false;
        showToast('Error connecting to server. Please try again.', 'error');
      }
    }
    
    // Load notes for the notes panel
    async function loadNotes() {
      const userId = localStorage.getItem('userId');
      const accessToken = localStorage.getItem('accessToken');
      const filterValue = document.getElementById('noteFilter').value;
      
      const notesList = document.getElementById('notesList');
      
      // Show loading state
      notesList.innerHTML = `
        <div class="loading-spinner">
          <div class="spinner">
            <div class="spinner-needle"></div>
            <div class="spinner-center"></div>
          </div>
        </div>
      `;
      
      try {
        const response = await fetch('/.netlify/functions/dashboard', {
          method: 'POST',
          body: JSON.stringify({
            action: 'getNotes',
            userId,
            topicId: filterValue === 'all' ? null : (filterValue === 'untagged' ? 'untagged' : filterValue)
          }),
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          }
        });
        
        const result = await response.json();
        
        if (response.ok) {
          notesList.innerHTML = '';
          
          if (result.notes && result.notes.length > 0) {
            result.notes.forEach((note, index) => {
              const noteItem = document.createElement('div');
              noteItem.className = 'note-item';
              
              const date = new Date(note.created_at);
              const formattedDate = `${date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}`;
              
              // Add delay for staggered animation effect
              noteItem.style.animationDelay = `${index * 0.05}s`;
              
              noteItem.innerHTML = `
                <div class="note-content">${note.content}</div>
                <div class="note-meta">
                  <div class="note-topic">${note.topic_name || 'Untagged'}</div>
                  <div class="note-date">${formattedDate}</div>
                </div>
                <div class="note-actions">
                  <button class="delete-note" data-note-id="${note.id}">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              `;
              
              notesList.appendChild(noteItem);
              
              // Add event listeners for delete buttons
              document.querySelectorAll('.delete-note').forEach(button => {
                button.addEventListener('click', async (e) => {
                  const noteId = e.currentTarget.dataset.noteId;
                  await deleteNote(noteId);
                });
              });
            });
            
            // Show notes list
            notesList.classList.remove('hidden');
          } else {
            notesList.innerHTML = `
              <div class="empty-notes">
                <i class="fas fa-sticky-note"></i>
                <p>No notes found</p>
              </div>
            `;
          }
        } else {
          notesList.innerHTML = `
            <div class="empty-notes">
              <p class="error-message">Failed to load notes: ${result.error || 'Unknown error'}</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading notes:', error);
        notesList.innerHTML = `
          <div class="empty-notes">
            <p class="error-message">Error connecting to server. Please try again.</p>
          </div>
        `;
      }
    }
    
    // Delete a note
    async function deleteNote(noteId) {
      if (!confirm('Are you sure you want to delete this note?')) return;
      
      const userId = localStorage.getItem('userId');
      const accessToken = localStorage.getItem('accessToken');
      
      try {
        const response = await fetch('/.netlify/functions/dashboard', {
          method: 'POST',
          body: JSON.stringify({
            action: 'deleteNote',
            userId,
            noteId
          }),
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          }
        });
        
        const result = await response.json();
        
        if (response.ok) {
          // Reload notes
          loadNotes();
          
          // Show success toast
          showToast('Note deleted successfully', 'success');
        } else {
          showToast('Error deleting note: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        console.error('Error deleting note:', error);
        showToast('Error connecting to server. Please try again.', 'error');
      }
    }
  </script>

  <!-- Notes Panel -->
  <div id="notesPanel" class="fixed top-0 right-0 w-96 h-screen bg-white shadow-lg z-50 flex flex-col border-l border-gray-200 transform translate-x-full transition-transform duration-300 ease-in-out">
    <div class="flex justify-between items-center p-5 bg-gray-50 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
        <i class="fas fa-sticky-note text-yellow-400"></i> Quick Notes
      </h2>
      <button class="text-2xl text-gray-500 hover:text-gray-700 transition-colors" id="closeNotesBtn">&times;</button>
    </div>
    
    <div class="flex-1 flex flex-col overflow-hidden">
      <div class="p-5 border-b border-gray-200">
        <textarea id="noteText" placeholder="Jot down a thought..." class="w-full h-24 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400 focus:border-transparent resize-none transition-all duration-200 font-eb-garamond"></textarea>
        <div class="flex gap-3 mt-4">
          <select id="noteTopic" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400 focus:border-transparent text-sm">
            <option value="">Untagged</option>
            <!-- Topics will be loaded here -->
          </select>
          <button id="saveNote" class="bg-yellow-400 hover:bg-yellow-500 text-gray-800 px-4 py-2 rounded-lg transition-colors duration-200 flex items-center gap-2">
            <i class="fas fa-save"></i> Save
          </button>
        </div>
      </div>
      
      <div class="flex justify-between items-center p-4 border-b border-gray-200">
        <h3 class="font-medium text-gray-800">Saved Notes</h3>
        <select id="noteFilter" class="p-1.5 text-sm border border-gray-300 rounded-lg">
          <option value="all">All Notes</option>
          <option value="untagged">Untagged</option>
          <!-- Topics will be loaded here -->
        </select>
      </div>
      
      <div id="notesList" class="flex-1 overflow-y-auto p-4">
        <!-- Notes will be loaded here -->
      </div>
    </div>
  </div>
</body>
</html>