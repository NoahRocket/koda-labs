<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Koda Tutor</title>
  <link rel="stylesheet" href="../styles/main.css">
  <link rel="stylesheet" href="../styles/navbar.css">
  <link rel="stylesheet" href="../styles/theme.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="../scripts/utils.js" defer></script>
  <script src="../scripts/theme.js" defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&display=swap" rel="stylesheet">

  <style>
    /* Dark Mode Overrides */
    .dark-mode .bg-blue-50 {
      background-color: rgba(30, 58, 138, 0.2); /* dark blue background */
    }
    
    .dark-mode .bg-green-50 {
      background-color: rgba(6, 78, 59, 0.2); /* dark green background */
    }
    
    .dark-mode .bg-blue-100 {
      background-color: rgba(30, 58, 138, 0.3); /* slightly darker blue for the icon background */
    }
    
    .dark-mode .bg-green-100 {
      background-color: rgba(6, 78, 59, 0.3); /* slightly darker green for the icon background */
    }
    
    .dark-mode .text-gray-600,
    .dark-mode .text-gray-700,
    .dark-mode .text-gray-800 {
      color: rgba(229, 231, 235, 0.9) !important; /* light text in dark mode */
    }
    
    /* Fix topic cards in dark mode */
    .dark-mode .topic-menu-btn:hover {
      background-color: rgba(55, 65, 81, 0.5) !important;
    }
    
    .dark-mode .dropdown-menu {
      background-color: var(--bg-secondary);
      border-color: var(--border-color);
    }
    
    .dark-mode .dropdown-menu button {
      color: var(--text-primary);
    }
    
    .dark-mode .dropdown-menu button:hover {
      background-color: var(--bg-tertiary);
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    /* Scrollbar styling */
    .tab-content::-webkit-scrollbar {
      width: 6px;
    }

    .tab-content::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .tab-content::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 10px;
    }

    .tab-content::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }

    /* Line clamp for multi-line text truncation */
    .line-clamp-1 {
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-clamp: 1;
    }

    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-clamp: 2;
    }
    
    /* New Topic Button Styling */
    .new-topic-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background-color: #00A3E0;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .new-topic-btn:hover {
      background-color: #0082b3;
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0, 163, 224, 0.3);
    }
    
    .new-topic-btn i {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 1.5rem;
      height: 1.5rem;
      background-color: white;
      border-radius: 50%;
      color: #00A3E0;
    }
    
    /* Toast Notification Styles */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000; /* High z-index to ensure it's on top */
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast {
      background-color: #fff;
      color: #333;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      justify-content: space-between;
      opacity: 0;
      transform: translateX(100%); /* Start off-screen */
      transition: opacity 0.3s ease, transform 0.3s ease;
      min-width: 250px;
      max-width: 350px;
    }

    .toast.active {
      opacity: 1;
      transform: translateX(0);
    }
    
    .toast.toast-closing {
        opacity: 0;
        transform: translateX(100%);
    }

    .toast-content {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .toast .fas {
      font-size: 1.2em;
    }

    .toast.success {
      border-left: 4px solid #4CAF50; /* Green for success */
    }
    .toast.success .fa-check-circle {
      color: #4CAF50;
    }

    .toast.error {
      border-left: 4px solid #F44336; /* Red for error */
    }
    .toast.error .fa-exclamation-circle {
      color: #F44336;
    }

    .toast.info {
      border-left: 4px solid #2196F3; /* Blue for info */
    }
    /* Add fa-info-circle styling if you use it for info toasts */
    /* .toast.info .fa-info-circle { color: #2196F3; } */

    .toast-close-btn {
      background: none;
      border: none;
      color: #aaa;
      font-size: 1.5em;
      line-height: 1;
      cursor: pointer;
      padding: 0 0 0 15px; /* Add some padding to make it easier to click */
      opacity: 0.7;
      transition: opacity 0.2s ease;
    }

    .toast-close-btn:hover {
      opacity: 1;
    }
  </style>
</head>

<body class="bg-gray-50 font-eb-garamond min-h-screen flex text-gray-900">
  <!-- Mobile Hamburger -->
  <div class="md:hidden fixed top-4 left-4 z-50 cursor-pointer p-2 mobile-touch-target" id="hamburger">
    <div class="w-6 h-0.5 bg-gray-800 mb-1"></div>
    <div class="w-6 h-0.5 bg-gray-800 mb-1"></div>
    <div class="w-6 h-0.5 bg-gray-800"></div>
  </div>

  <!-- Sidebar Navigation -->
  <div id="sidebar" class="fixed top-0 left-0 h-screen w-64 app-sidebar transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-40">
    <div class="flex flex-col h-full">
      <div class="logo-container pt-12 md:pt-5">
        <h1 class="app-logo">Koda <span>Tutor</span></h1>
        <button id="closeSidebar" class="absolute top-5 right-4 text-gray-300 hover:text-white md:hidden mobile-touch-target">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <!-- User Avatar Display -->
      <div class="p-4 flex justify-center border-b border-gray-700">
        <div class="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center overflow-hidden" id="avatarContainer">
          <img id="dashboardSidebarUserAvatar" src="" alt="User Avatar" class="w-full h-full object-cover opacity-0 transition-opacity duration-300">
          <!-- Loading indicator -->
          <div id="avatarLoading" class="absolute">
            <i class="fas fa-circle-notch fa-spin text-gray-400"></i>
          </div>
        </div>
      </div>
      <nav class="flex-1 overflow-y-auto py-4">
        <ul class="space-y-1 px-4">
        <li id="loggedInNav" class="hidden flex-col space-y-1">
          <a href="dashboard.html" class="nav-link active">
            <i class="fas fa-compass"></i>
            <span class="mobile-readable">Dashboard</span>
          </a>
          <a href="chat.html" class="nav-link">
            <i class="fas fa-comments"></i>
            <span class="mobile-readable">Chat</span>
          </a>

          <a href="podcasts.html" class="nav-link">
            <i class="fas fa-podcast"></i>
            <span class="mobile-readable">Podcasts</span>
          </a>
          <a href="settings.html" class="nav-link">
            <i class="fas fa-cog"></i>
            <span class="mobile-readable">Settings</span>
          </a>
        </li>
        <li id="loggedOutNav" class="hidden flex-col space-y-1">
          <a href="login.html" class="nav-link">
            <i class="fas fa-sign-in-alt"></i>
            <span>Login</span>
          </a>
          <a href="signup.html" class="nav-link">
            <i class="fas fa-user-plus"></i>
            <span>Sign Up</span>
          </a>
        </li>
        </ul>
      </nav>
      
      <div class="p-4 border-t border-gray-700">
        <button id="logout" class="logout-btn w-full">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="md:ml-64 flex-1 p-4 md:p-8 min-h-screen">
    <div class="flex justify-between items-start mb-8">
      <div class="text-left">
        <h1 class="text-4xl font-bold text-gray-800 mb-2">Welcome Back! ðŸš€</h1>
        <p class="text-lg text-gray-600">Continue your AI-powered learning journey and unlock your potential</p>
      </div>
      <button class="new-topic-btn" id="showAddTopicModal">
        <i class="fas fa-plus"></i>
        <span>New Topic</span>
      </button>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-8">
      <!-- Active Topics Card -->
      <div class="bg-blue-50 rounded-xl p-6 flex items-center justify-between">
        <div>
          <h3 class="text-lg font-semibold text-gray-700">Active Topics</h3>
          <p class="text-3xl font-bold text-blue-600" id="activeTopicsCount">0</p>
        </div>
        <div class="bg-blue-100 p-4 rounded-full">
          <i class="fas fa-book text-blue-500 text-2xl"></i>
        </div>
      </div>
      <!-- AI Conversations Card -->
      <div class="bg-green-50 rounded-xl p-6 flex items-center justify-between">
        <div>
          <h3 class="text-lg font-semibold text-gray-700">AI Conversations</h3>
          <p class="text-3xl font-bold text-green-600" id="savedConversationsCount">0</p>
        </div>
        <div class="bg-green-100 p-4 rounded-full">
          <i class="fas fa-comment text-green-500 text-2xl"></i>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 my-8" id="topicsGrid">
      <!-- Topics will be loaded here -->
      <div class="flex justify-center items-center" id="topicsLoading">
        <div class="relative w-10 h-10 border-2 border-gray-200 rounded-full">
          <div class="absolute top-1/2 left-1/2 w-0.5 h-3.5 bg-gradient-to-b from-red-500 to-red-600 transform-gpu origin-bottom animate-spin"></div>
          <div class="absolute w-1.5 h-1.5 bg-gray-800 rounded-full top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Topic Modal -->
  <div class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden" id="topicModal">
    <div class="bg-white w-11/12 max-w-4xl mx-auto rounded-xl shadow-lg max-h-[90vh] overflow-hidden transition-all duration-300 flex flex-col" id="modalContent">
      <div class="p-6 border-b border-gray-200">
        <div class="flex justify-between items-center">
          <h2 id="modalTopicName" class="text-2xl font-bold text-gray-800"></h2>
          <button id="closeTopicModal" class="text-2xl text-gray-500 hover:text-gray-700">Ã—</button>
        </div>
      </div>
      
      <div class="overflow-y-auto flex-1 p-6" style="max-height: 70vh">
        <div class="border-b border-gray-200 mb-6">
          <div class="flex space-x-6">
            <button class="tab-button active" data-tab="conversations">
              <i class="fas fa-comments mr-2"></i> Conversations
            </button>
            <button class="tab-button" data-tab="bookmarks">
              <i class="fas fa-bookmark mr-2"></i> Bookmarks
            </button>
            <button class="tab-button" data-tab="notes">
              <i class="fas fa-sticky-note mr-2"></i> Notes
            </button>
            <button class="tab-button" data-tab="summary">
              <i class="fas fa-magic mr-2"></i> Summary
            </button>
          </div>
        </div>
        
        <div class="tab-content block" id="conversationsTab">
          <div id="conversationsList" class="space-y-4">
            <!-- Conversations will be loaded here -->
          </div>
        </div>
        
        <div class="tab-content hidden" id="bookmarksTab">
          <div id="bookmarksList" class="space-y-4">
            <!-- Bookmarks will be loaded here -->
          </div>
        </div>
        
        <div class="tab-content hidden" id="notesTab">
          <div id="topicNotesList" class="space-y-4">
            <!-- Notes will be loaded here -->
          </div>
          
          <div class="mt-6">
            <textarea id="newNoteContent" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" rows="4" placeholder="Add a new note..."></textarea>
            <button id="saveNoteBtn" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
              <i class="fas fa-save mr-2"></i> Save Note
            </button>
          </div>
        </div>
        
        <div class="tab-content hidden" id="summaryTab">
          <div class="mb-6">
            <h3 class="text-xl font-semibold mb-2">Topic Summary</h3>
            <p class="text-gray-600 mb-4">Generate a summary to see the key points from all your conversations, bookmarks, and notes in this topic.</p>
            
            <button id="generateSummaryBtn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
              <i class="fas fa-magic mr-2"></i> Generate Summary
            </button>
          </div>
          <div id="summaryLoading" class="hidden flex justify-center items-center py-8">
            <div class="text-center">
              <i class="fas fa-circle-notch fa-spin fa-2x text-gray-300 mb-3"></i>
              <p class="text-gray-500">Generating summary... This may take a moment.</p>
            </div>
          </div>
          <!-- Learning Highlights Section (Card Layout) -->
          <div id="summaryContent" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
            <!-- Cards will be injected here by JS as Tailwind-styled cards -->
          </div>
          <template id="highlightCardTemplate">
            <div class="bg-white rounded-xl shadow-md p-5 flex flex-col justify-between h-full border border-gray-100 hover:shadow-lg transition group">
              <div>
                <div class="font-bold text-lg mb-1 text-blue-700">{{concept}}</div>
                <div class="text-gray-700 mb-2 line-clamp-2">{{description}}</div>
              </div>
              <div class="flex items-center justify-between mt-3">
                <span class="text-xs text-gray-400 font-medium">{{source}}</span>
                <div class="flex gap-2">
                  <button class="revisit-btn px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 font-semibold transition">Revisit</button>
                  <button class="quiz-btn px-3 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200 font-semibold transition">Quiz Me</button>
                </div>
              </div>
            </div>
          </template>
          <div id="summaryMeta" class="mt-4 text-sm text-gray-500 hidden">
            <p>Last updated: <span id="summaryLastUpdated"></span></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Topic Modal -->
  <div class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden" id="addTopicModal">
    <div class="bg-white w-11/12 max-w-md mx-auto rounded-xl shadow-lg overflow-hidden transition-all duration-300 flex flex-col" id="addTopicModalContent">
      <div class="p-6 border-b border-gray-200">
        <div class="flex justify-between items-center">
          <h2 class="text-xl font-bold text-gray-800">Create New Topic</h2>
          <button id="closeAddTopicModal" class="text-2xl text-gray-500 hover:text-gray-700">Ã—</button>
        </div>
      </div>
      <div class="p-6">
        <input type="text" id="newTopicInputDashboard" placeholder="Enter new topic name" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-4">
        <button id="submitNewTopicBtn" style="background-color:#00A3E0;" class="w-full hover:bg-blue-600 text-white px-4 py-2 rounded-md transition-colors duration-200">Add Topic</button>
      </div>
    </div>
  </div>


  <!-- Audio for success sound -->
  <audio id="saveSuccessSound" preload="auto" src="../sounds/success-chime.mp3"></audio>

  <!-- Loading Spinner Template -->
  <template id="loadingSpinnerTemplate">
    <div class="flex justify-center items-center py-8">
      <div class="relative w-10 h-10 border-2 border-gray-200 rounded-full">
        <div class="absolute top-1/2 left-1/2 w-0.5 h-3.5 bg-gradient-to-b from-green-500 to-green-600 transform-gpu origin-bottom animate-spin"></div>
        <div class="absolute w-1.5 h-1.5 bg-gray-800 rounded-full top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></div>
      </div>
    </div>
  </template>
  
  <!-- Empty State Template -->
  <template id="emptyStateTemplate">
    <div class="text-center py-10">
      <div class="text-gray-400 mb-3">
        <i class="fas fa-folder-open text-4xl"></i>
      </div>
      <h3 class="text-lg font-medium text-gray-700 mb-1">No items found</h3>
      <p class="text-gray-500 text-sm">There are no items to display.</p>
    </div>
  </template>

  <script>
    // Global variables
    let topics = [];
    let currentTopicId = null;
    
    // Defensive checks for missing functions
    if (typeof loadNotes !== 'function') {
      window.loadNotes = function() { console.warn('loadNotes is not implemented'); };
    }
    if (typeof loadTopicNotes !== 'function') {
      window.loadTopicNotes = function() { console.warn('loadTopicNotes is not implemented'); };
    }
    if (typeof handleSaveNote !== 'function') {
      window.handleSaveNote = function() { console.warn('handleSaveNote is not implemented'); };
    }
    if (typeof createNewTopic !== 'function') {
      window.createNewTopic = function() { console.warn('createNewTopic is not implemented'); };
    }
    if (typeof renameTopic !== 'function') {
      window.renameTopic = function() { console.warn('renameTopic is not implemented'); };
    }
    if (typeof deleteTopic !== 'function') {
      window.deleteTopic = function() { console.warn('deleteTopic is not implemented'); };
    }

    // Toast notification placeholder
    function showToast(message, type = 'info') {
      console.log(`Toast [${type}]: ${message}`);
      const toast = document.createElement('div');
      toast.className = `fixed bottom-4 right-4 p-4 rounded-lg text-white ${type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500'}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Centralized API error handling
    function handleApiError(container, error, retryCallback) {
      container.innerHTML = `
        <div class="text-center py-8">
          <i class="fas fa-exclamation-circle text-red-500 text-4xl mb-4"></i>
          <h3 class="text-xl font-semibold text-gray-700 mb-2">Error loading data</h3>
          <p class="text-gray-500 mb-4">${error.message || 'Please try again later'}</p>
          <button class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors retry-btn">
            <i class="fas fa-redo mr-2"></i> Retry
          </button>
        </div>
      `;
      const retryBtn = container.querySelector('.retry-btn');
      if (retryBtn && retryCallback) {
        retryBtn.addEventListener('click', retryCallback);
      }
    }

    // Set loading state using template
    function setLoadingState(containerId) {
      const container = document.getElementById(containerId);
      if (container) {
        const template = document.getElementById('loadingSpinnerTemplate');
        container.innerHTML = template.innerHTML;
      }
    }

    // Document ready function
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM fully loaded');

      // Check authentication
      const userId = localStorage.getItem('userId');
      const accessToken = localStorage.getItem('accessToken');
      if (!userId || !accessToken) {
        console.log('User not logged in, redirecting');
        window.location.href = '/';
        return;
      }

      // Update navigation
      updateNavigation();

      // Load topics
      loadTopics();

      // Setup event listeners
      setupEventListeners();
      loadTutorAvatar();
    });

    // Update navigation based on login status
    function updateNavigation() {
      const userId = localStorage.getItem('userId');
      const accessToken = localStorage.getItem('accessToken');
      const isLoggedIn = userId && accessToken;
      const loggedInNav = document.getElementById('loggedInNav');
      const loggedOutNav = document.getElementById('loggedOutNav');
      
      if (isLoggedIn) {
        loggedInNav.style.display = 'block';
        loggedOutNav.style.display = 'none';
      } else {
        loggedInNav.style.display = 'none';
        loggedOutNav.style.display = 'block';
        window.location.href = '/pages/login.html';
      }
    }

    // Load topics
    async function loadTopics() {
      console.log('Loading topics...');
      
      const topicsGrid = document.getElementById('topicsGrid');
      const topicsLoading = document.getElementById('topicsLoading');
      const activeTopicsCount = document.getElementById('activeTopicsCount');
      const savedConversationsCount = document.getElementById('savedConversationsCount');
      
      if (!topicsGrid) {
        console.error('Topics grid not found');
        return;
      }
      
      try {
        const userId = localStorage.getItem('userId');
        const accessToken = localStorage.getItem('accessToken');
        
        topicsLoading.style.display = 'flex';
        
        const response = await fetch('/.netlify/functions/dashboard', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          },
          body: JSON.stringify({
            action: 'getTopics',
            userId
          })
        });
        
        if (!response.ok) {
          throw new Error(`Server responded with status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('Topics loaded:', result);
        
        topicsLoading.style.display = 'none';
        
        Array.from(topicsGrid.children).forEach(child => {
          if (child.id !== 'topicsLoading') {
            child.remove();
          }
        });
        
        topics = result.topics || [];
        
        // Update stats cards
        if (activeTopicsCount) {
          activeTopicsCount.textContent = topics.length;
        }
        
        // Count saved conversations
        let totalConversations = 0;
        topics.forEach(topic => {
          totalConversations += (topic.conversation_count || 0);
        });
        
        if (savedConversationsCount) {
          savedConversationsCount.textContent = totalConversations;
        }
        
        if (topics.length === 0) {
          const emptyState = document.createElement('div');
          emptyState.className = 'col-span-3 text-center py-8';
          emptyState.innerHTML = `
            <div class="text-center py-8">
              <i class="fas fa-book text-gray-300 text-6xl mb-4"></i>
              <h3 class="text-xl font-semibold text-gray-700 mb-2">No topics yet</h3>
              <p class="text-gray-500 mb-4">Create your first topic to get started!</p>
              <button class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors duration-200" id="createFirstTopic">
                <i class="fas fa-plus mr-2"></i> Create Topic
              </button>
            </div>
          `;
          
          topicsGrid.appendChild(emptyState);
          
          document.getElementById('createFirstTopic')?.addEventListener('click', () => {
            document.getElementById('showAddTopicModal').click();
          });
        } else {
          topics.forEach((topic, index) => {
            const card = createTopicCard(topic);
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            topicsGrid.appendChild(card);
            
            setTimeout(() => {
              card.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
              card.style.opacity = '1';
              card.style.transform = 'translateY(0)';
            }, index * 100);
          });
        }
      } catch (error) {
        console.error('Error loading topics:', error);
        topicsLoading.style.display = 'none';
        handleApiError(topicsGrid, error, loadTopics);
      }
    }

    function showLoadingIndicator() {
      const indicator = document.getElementById('topicsLoading');
      if (indicator) {
        indicator.style.display = 'flex'; // Use 'flex' as per the element's class
      }
    }

    function hideLoadingIndicator() {
      const indicator = document.getElementById('topicsLoading');
      if (indicator) {
        indicator.style.display = 'none';
      }
    }

    // Create topic card
    function createTopicCard(topic) {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-lg shadow-sm hover:shadow-md transition-all duration-200 overflow-hidden cursor-pointer';
      card.style.borderTop = '3px solid #00A3E0';
      card.style.boxShadow = '0 1px 3px rgba(0,0,0,0.05)';
      card.style.height = '130px'; // Make cards wider than tall
      card.style.display = 'flex';
      card.style.flexDirection = 'column';
      card.style.transform = 'translateY(0)';
      card.style.transition = 'transform 0.2s ease, box-shadow 0.2s ease';
      card.id = `topic-${topic.id}`;
      card.dataset.topicId = topic.id;

      const createdDate = new Date(topic.created_at);
      const formattedDate = createdDate.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });

      card.innerHTML = `
        <div class="p-4 flex-1 flex flex-col">
          <div class="flex justify-between items-center mb-2">
            <h3 class="text-base font-semibold text-gray-800 line-clamp-1">
              <span class="emoji mr-2">${topic.emoji || 'ðŸ“š'}</span>
              <span class="topic-name">${topic.name}</span>
            </h3>
            <div class="dropdown relative">
              <button class="text-gray-400 hover:text-gray-600 transition-colors p-1 rounded-full hover:bg-gray-100 topic-menu-btn">
                <i class="fas fa-ellipsis-v"></i>
              </button>
              <div class="dropdown-menu hidden absolute right-0 mt-1 bg-white shadow-lg rounded-lg overflow-hidden z-10 w-48 border border-gray-200">
                <button class="w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100 transition-colors flex items-center gap-2 relative rename-topic" data-id="${topic.id}">
                  <i class="fas fa-edit text-blue-500"></i> Rename
                </button>
                <button class="w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100 transition-colors flex items-center gap-2 relative delete-topic" data-id="${topic.id}">
                  <i class="fas fa-trash-alt text-red-500"></i> Delete
                </button>
              </div>
            </div>
          </div>
          <p class="text-gray-500 text-xs mb-2 flex-grow" style="color: #6B7280;">
            ${topic.description || ''}
          </p>
          <div class="flex justify-between items-center text-xs text-gray-400 mt-auto">
            <span><i class="fas fa-calendar-alt mr-1"></i> ${formattedDate}</span>
            <span><i class="fas fa-comment mr-1"></i> ${topic.conversation_count || 0} conversation${topic.conversation_count !== 1 ? 's' : ''}</span>
          </div>
        </div>
      `;

      card.addEventListener('click', (e) => {
        // If the click is on the card itself and not on the dropdown or its children
        if (!e.target.closest('.dropdown') && e.target.closest(`#topic-${topic.id}`)) {
          window.location.href = `topic-view.html?topicId=${topic.id}`;
        }
      });
      
      // Add hover effect
      card.addEventListener('mouseenter', () => {
        card.style.transform = 'translateY(-3px)';
        card.style.boxShadow = '0 4px 8px rgba(0,0,0,0.08)';
      });
      
      card.addEventListener('mouseleave', () => {
        card.style.transform = 'translateY(0)';
        card.style.boxShadow = '0 1px 3px rgba(0,0,0,0.05)';
      });

      const menuBtn = card.querySelector('.topic-menu-btn');
      const dropdownMenu = card.querySelector('.dropdown-menu');

      menuBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent card click event
        dropdownMenu.classList.toggle('hidden');
      });

      // Close dropdown if clicked outside
      document.addEventListener('click', (e) => {
        if (!card.contains(e.target)) { // if click is outside the card
            dropdownMenu.classList.add('hidden');
        }
      });

      const renameBtn = card.querySelector('.rename-topic');
      renameBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent card click event
        dropdownMenu.classList.add('hidden'); // Hide menu after action
        const topicId = e.currentTarget.getAttribute('data-id');
        const topicNameSpan = card.querySelector('.topic-name'); // Get the span containing only the topic name
        const currentTopicName = topicNameSpan ? topicNameSpan.textContent : topic.name; // Use its text content
        const newName = prompt('Enter new topic name:', currentTopicName);

        if (newName && newName.trim() !== '' && newName !== currentTopicName) {
          renameTopic(topicId, newName.trim());
        }
      });

      const deleteBtn = card.querySelector('.delete-topic');
      deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent card click event
        dropdownMenu.classList.add('hidden'); // Hide menu after action
        const topicId = e.currentTarget.getAttribute('data-id');
        if (confirm(`Are you sure you want to delete "${topic.name}"? This will delete all conversations, bookmarks, and notes in this topic.`)) {
          deleteTopic(topicId);
        }
      });

      const emojiSpan = card.querySelector('.emoji');
      emojiSpan.addEventListener('click', (e) => {
        e.stopPropagation();
        const topicId = card.dataset.topicId;
        const currentEmoji = emojiSpan.textContent;
        const newEmoji = prompt('Enter new emoji for this topic:', currentEmoji);
        if (newEmoji && newEmoji.trim() !== '' && newEmoji !== currentEmoji) {
          updateEmoji(topicId, newEmoji.trim());
        }
      });

      return card;
    }

    // Open topic modal
    function openTopicModal(topicId) {
      console.log('Opening topic modal for:', topicId);
      
      const userId = localStorage.getItem('userId');
      const accessToken = localStorage.getItem('accessToken');
      
      if (!userId || !accessToken) {
        window.location.href = '/';
        return;
      }
      
      const topicModal = document.getElementById('topicModal');
      const modalContent = document.getElementById('modalContent');
      const modalTopicName = document.getElementById('modalTopicName');
      const summaryContent = document.getElementById('summaryContent');
      
      if (summaryContent) {
        summaryContent.innerHTML = '';
      }
      
      topicModal.setAttribute('data-topic-id', topicId);
      
      const topic = topics.find(t => t.id === topicId);
      if (!topic) {
        console.error('Topic not found:', topicId);
        return;
      }
      
      modalTopicName.textContent = topic.name;
      
      topicModal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      
      setTimeout(() => {
        modalContent.classList.remove('opacity-0', 'translate-y-5');
      }, 10);
      
      const tabBtns = document.querySelectorAll('[data-tab]'); 
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabBtns.forEach(btn => btn.classList.remove('active'));
      tabContents.forEach(content => content.classList.add('hidden'));
      
      document.querySelector('[data-tab="conversations"]').classList.add('active');
      document.getElementById('conversationsTab').classList.remove('hidden');
      
      currentTopicId = topicId;
      loadConversations(topicId);
      loadBookmarks(topicId);
      loadTopicNotes(topicId);
      loadTopicSummary(topicId); 
    }

    // Load topic summary
    async function loadTopicSummary(topicId) {
      console.log('[DEBUG] Calling loadTopicSummary for topic:', topicId);
      const userId = localStorage.getItem('userId');
      const accessToken = localStorage.getItem('accessToken');
      const summaryContent = document.getElementById('summaryContent');
      const summaryLoading = document.getElementById('summaryLoading');

      if (!summaryContent) {
        console.error('Summary content container not found');
        return;
      }

      if (summaryLoading) summaryLoading.style.display = 'flex';
      setLoadingState('summaryContent');

      try {
        const response = await fetch('/.netlify/functions/summary', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          },
          body: JSON.stringify({
            action: 'getSummary',
            topic_id: topicId,
            user_id: userId
          })
        });
        
        console.log('[DEBUG] Summary API response status:', response.status);
        const result = await response.json();
        console.log('[DEBUG] Summary API result:', result);
        
        if (!response.ok) {
          throw new Error(result.error || 'Failed to fetch summary');
        }
        
        if (summaryLoading) summaryLoading.style.display = 'none';
        
        if (result.summary && result.summary.highlights && result.summary.highlights.length > 0) {
          const highlightCards = result.summary.highlights.map(highlight => {
            const template = document.getElementById('highlightCardTemplate');
            const clone = template.content.cloneNode(true);
            clone.querySelector('.font-bold').textContent = highlight.concept;
            clone.querySelector('.text-gray-700').textContent = highlight.description;
            clone.querySelector('.text-xs').textContent = highlight.source;
            return clone;
          });
          summaryContent.innerHTML = '';
          highlightCards.forEach(card => summaryContent.appendChild(card));
          summaryContent.style.display = 'block';
          
          const summaryMeta = document.getElementById('summaryMeta');
          const summaryLastUpdated = document.getElementById('summaryLastUpdated');
          
          if (summaryMeta && summaryLastUpdated && result.summary.created_at) {
            summaryLastUpdated.textContent = formatDate(result.summary.created_at);
            summaryMeta.style.display = 'block';
          }
        } else if (result.summary) {
          summaryContent.innerHTML = '<p class="text-gray-500">No summary highlights found for this topic.</p>';
          summaryContent.style.display = 'block';
        } else {
          summaryContent.innerHTML = '<p class="text-gray-500">No summary found for this topic. Click Generate Summary to create one!</p>';
          summaryContent.style.display = 'block';
          const summaryMeta = document.getElementById('summaryMeta');
          if (summaryMeta) summaryMeta.style.display = 'none';
        }
      } catch (error) {
        console.error('Error loading summary:', error);
        if (summaryLoading) summaryLoading.style.display = 'none';
        handleApiError(summaryContent, error, () => loadTopicSummary(topicId));
      }
    }

    // Generate summary
    async function generateSummary() {
      console.log('[Debug] Starting summary generation...');
      const summaryContent = document.getElementById('summaryContent');
      const summaryLoading = document.getElementById('summaryLoading');
      const summaryMeta = document.getElementById('summaryMeta');
      const generateBtn = document.getElementById('generateSummaryBtn');
      
      const topicId = document.getElementById('topicModal').getAttribute('data-topic-id');
      console.log('[Debug] Topic ID from modal attribute:', topicId);
      
      if (!topicId) {
        showToast('Could not determine topic ID', 'error');
        return;
      }
      
      generateBtn.disabled = true;
      generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
      summaryContent.style.display = 'none';
      if (summaryLoading) summaryLoading.style.display = 'flex';
      if (summaryMeta) summaryMeta.style.display = 'none';
      
      const userId = localStorage.getItem('userId');
      const accessToken = localStorage.getItem('accessToken');
      
      try {
        const response = await fetch('/.netlify/functions/summary', {
          method: 'POST',
          body: JSON.stringify({
            action: 'generateSummary',
            topic_id: topicId,
            user_id: userId
          }),
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('[Debug] Summary generation response:', result);
        
        if (result.summary) {
          const highlightCards = result.summary.highlights.map(highlight => {
            const template = document.getElementById('highlightCardTemplate');
            const clone = template.content.cloneNode(true);
            clone.querySelector('.font-bold').textContent = highlight.concept;
            clone.querySelector('.text-gray-700').textContent = highlight.description;
            clone.querySelector('.text-xs').textContent = highlight.source;
            return clone;
          });
          summaryContent.innerHTML = '';
          highlightCards.forEach(card => summaryContent.appendChild(card));
          summaryContent.style.display = 'block';
          
          if (summaryMeta && result.summary.last_source_updated_at) {
            const lastUpdatedEl = document.getElementById('summaryLastUpdated');
            if (lastUpdatedEl) {
              lastUpdatedEl.textContent = formatDate(result.summary.last_source_updated_at);
              summaryMeta.style.display = 'block';
            }
          }
          
          showToast('Summary generated successfully', 'success');
        } else {
          summaryContent.innerHTML = `<p class="text-red-500">Failed to generate summary: ${result.error || 'Unknown error'}</p>`;
          summaryContent.style.display = 'block';
          showToast(`Summary generation failed: ${result.error || 'Unknown error'}`, 'error');
        }
      } catch (error) {
        console.error('[Debug] Error generating summary:', error);
        summaryContent.innerHTML = `<p class="text-red-500">Error connecting to server. Please try again.</p>`;
        summaryContent.style.display = 'block';
        showToast('Network error. Please check your internet connection.', 'error');
      } finally {
        if (summaryLoading) summaryLoading.style.display = 'none';
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<i class="fas fa-magic"></i> Generate Summary';
      }
    }

    // Load conversations
    async function loadConversations(topicId) {
      const userId = localStorage.getItem('userId');
      const accessToken = localStorage.getItem('accessToken');
      const conversationsList = document.getElementById('conversationsList');
      if (!conversationsList) {
        console.error('Conversations list container not found');
        return;
      }
      setLoadingState('conversationsList');
      try {
        const response = await fetch('/.netlify/functions/dashboard', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          },
          body: JSON.stringify({
            action: 'getTopicDetails',
            userId,
            topicId
          })
        });
        if (!response.ok) {
          throw new Error(`Server responded with status: ${response.status}`);
        }
        const result = await response.json();
        if (result.conversations && result.conversations.length > 0) {
          conversationsList.innerHTML = '';
          result.conversations.forEach(conversation => {
            const conversationItem = document.createElement('div');
            conversationItem.className = 'rounded-lg mb-4 p-4 bg-white shadow-sm transition-shadow duration-200 hover:shadow-md';
            const fullContent = conversation.content;
            const isTruncated = fullContent.length > 300;
            const displayContent = isTruncated ? fullContent.substring(0, 300) + '...' : fullContent;
            conversationItem.innerHTML = `
              <div class="flex justify-between items-start mb-2">
                <span class="text-sm text-gray-500">${new Date(conversation.created_at).toLocaleDateString()}</span>
                <button class="delete-conversation-btn text-red-500 hover:text-red-700 transition-colors" data-id="${conversation.id}">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
              <div class="conversation-content">
                <p class="text-gray-700 whitespace-pre-wrap">${displayContent}</p>
                ${isTruncated ? 
                  `<button class="text-blue-500 hover:text-blue-700 text-sm mt-2 show-more-btn">Show more</button>
                   <div class="full-content hidden">
                     <div class="max-h-96 overflow-y-auto pr-2 my-2">
                       <p class="text-gray-700 whitespace-pre-wrap">${fullContent}</p>
                     </div>
                     <button class="text-blue-500 hover:text-blue-700 text-sm mt-2 show-less-btn">Show less</button>
                   </div>` 
                  : ''}
              </div>
            `;
            conversationsList.appendChild(conversationItem);
            if (isTruncated) {
              const showMoreBtn = conversationItem.querySelector('.show-more-btn');
              const showLessBtn = conversationItem.querySelector('.show-less-btn');
              const truncatedContent = conversationItem.querySelector('.conversation-content > p');
              const fullContentDiv = conversationItem.querySelector('.full-content');
              showMoreBtn.addEventListener('click', () => {
                truncatedContent.classList.add('hidden');
                showMoreBtn.classList.add('hidden');
                fullContentDiv.classList.remove('hidden');
              });
              showLessBtn.addEventListener('click', () => {
                truncatedContent.classList.remove('hidden');
                showMoreBtn.classList.remove('hidden');
                fullContentDiv.classList.add('hidden');
              });
            }
            conversationItem.querySelector('.delete-conversation-btn').addEventListener('click', (e) => {
              e.stopPropagation();
              const conversationId = e.currentTarget.getAttribute('data-id');
              if (confirm('Are you sure you want to delete this conversation?')) {
                deleteConversation(conversationId);
              }
            });
          });
        } else {
          conversationsList.innerHTML = `
            <div class="flex flex-col items-center justify-center py-12 text-gray-400 text-center">
              <i class="fas fa-comment text-4xl"></i>
              <p>No conversations in this topic yet.</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading conversations:', error);
        handleApiError(conversationsList, error, () => loadConversations(topicId));
      }
    }

    // Load bookmarks
    async function loadBookmarks(topicId) {
      const userId = localStorage.getItem('userId');
      const accessToken = localStorage.getItem('accessToken');
      const bookmarksList = document.getElementById('bookmarksList');
      if (!bookmarksList) {
        console.error('Bookmarks list container not found');
        return;
      }
      setLoadingState('bookmarksList');
      try {
        const response = await fetch('/.netlify/functions/dashboard', {
          method: 'POST',
          body: JSON.stringify({
            action: 'getTopicDetails',
            userId,
            topicId
          }),
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          }
        });
        if (!response.ok) {
          throw new Error(`Server responded with status: ${response.status}`);
        }
        const result = await response.json();
        if (result.bookmarks && result.bookmarks.length > 0) {
          bookmarksList.innerHTML = '';
          result.bookmarks.forEach(bookmark => {
            const bookmarkItem = document.createElement('div');
            bookmarkItem.className = 'rounded-lg mb-4 p-4 bg-white shadow-sm transition-shadow duration-200 hover:shadow-md';
            bookmarkItem.innerHTML = `
              <div class="bookmark blÃ¥-header">
                <span class="bookmark-date">${new Date(bookmark.created_at).toLocaleDateString()}</span>
              </div>
              <div class="bookmark-content">
                <a href="${bookmark.url}" target="_blank" class="bookmark-link">
                  <i class="fas fa-external-link-alt"></i> ${bookmark.url}
                </a>
              </div>
            `;
            bookmarksList.appendChild(bookmarkItem);
          });
        } else {
          bookmarksList.innerHTML = `
            <div class="flex flex-col items-center justify-center py-12 text-gray-400 text-center">
              <i class="fas fa-bookmark text-4xl"></i>
              <p>No bookmarks in this topic yet.</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading bookmarks:', error);
        handleApiError(bookmarksList, error, () => loadBookmarks(topicId));
      }
    }

    // Delete conversation
    async function deleteConversation(conversationId) {
      const accessToken = localStorage.getItem('accessToken');
      
      try {
        showToast('Deleting conversation...', 'info');
        
        const response = await fetch('/.netlify/functions/chatgpt', {
          method: 'POST',
          body: JSON.stringify({
            action: 'deleteConversation',
            conversationId
          }),
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          }
        });
        
        const result = await response.json();
        
        if (response.ok) {
          showToast('Conversation deleted successfully', 'success');
          const currentTopicId = document.getElementById('topicModal').getAttribute('data-topic-id');
          if (currentTopicId) {
            loadConversations(currentTopicId);
          }
        } else {
          showToast('Error: ' + (result.error || 'Failed to delete conversation'), 'error');
        }
      } catch (error) {
        console.error('Error deleting conversation:', error);
        showToast('Error connecting to server', 'error');
      }
    }

    // Format date
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return '<span style="font-size:12px;font-style:italic;color:#6B7280;">Invalid Date</span>';
      return date.toLocaleString();
    }

    // Delete Topic Functionality
    async function deleteTopic(topicId) {
      const userId = localStorage.getItem('userId');
      const accessToken = localStorage.getItem('accessToken');

      if (!userId || !accessToken) {
        showToast('User not authenticated. Please log in.', 'error');
        // Optionally redirect to login
        // window.location.href = '/pages/login.html';
        return;
      }

      // Confirmation is already handled in createTopicCard, but good for direct calls if any
      // if (!confirm('Are you sure you want to delete this topic? This action cannot be undone.')) return;

      try {
        const response = await fetch('/.netlify/functions/dashboard', {
          method: 'POST',
          body: JSON.stringify({
            action: 'deleteTopic',
            userId,
            topicId
          }),
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          }
        });

        const result = await response.json(); // Always parse JSON response

        if (!response.ok) {
          throw new Error(result.error || 'Failed to delete topic');
        }

        const topicCard = document.getElementById(`topic-${topicId}`);
        if (topicCard) {
          topicCard.remove();
        }
        showToast('Topic deleted successfully!', 'success');
        
        // Optional: If you have a counter or a message for no topics, update it here
        // checkTopicDisplay(); 

      } catch (error) {
        console.error('Error deleting topic:', error);
        showToast(error.message || 'Failed to delete topic. Please try again.', 'error');
      }
    }

    // Rename Topic Functionality
    async function renameTopic(topicId, newName) {
      const userId = localStorage.getItem('userId');
      const accessToken = localStorage.getItem('accessToken');
      if (!userId || !accessToken) {
        showToast('You need to be logged in to rename topics', 'error');
        return;
      }

      try {
        showLoadingIndicator();
        const response = await fetch('/.netlify/functions/dashboard', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          },
          body: JSON.stringify({
            action: 'renameTopic',
            userId,
            topicId,
            topicName: newName
          })
        });

        const data = await response.json();
        hideLoadingIndicator();

        if (response.ok) {
          // Update the topic card in the UI
          const topicCard = document.getElementById(`topic-${topicId}`);
          if (topicCard) {
            const topicNameElement = topicCard.querySelector('.topic-name');
            if (topicNameElement) {
              topicNameElement.textContent = newName;
            }
          }
          showToast(`Topic renamed to "${newName}"`, 'success');
        } else {
          showToast(`Error renaming topic: ${data.error || 'Unknown error'}`, 'error');
        }
      } catch (error) {
        hideLoadingIndicator();
        console.error('Error renaming topic:', error);
        showToast('Failed to rename topic. Please try again.', 'error');
      }
    }

    // Update Emoji Functionality
    async function updateEmoji(topicId, newEmoji) {
      const userId = localStorage.getItem('userId');
      const accessToken = localStorage.getItem('accessToken');
      if (!userId || !accessToken) {
        showToast('You need to be logged in to change emoji', 'error');
        return;
      }
      try {
        const response = await fetch('/.netlify/functions/dashboard', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          },
          body: JSON.stringify({
            action: 'updateEmoji',
            topicId,
            emoji: newEmoji
          })
        });
        const data = await response.json();
        if (response.ok) {
          const emojiElement = document.querySelector(`#topic-${topicId} .emoji`);
          if (emojiElement) emojiElement.textContent = newEmoji;
          showToast('Emoji updated', 'success');
        } else {
          showToast(`Error updating emoji: ${data.error || 'Unknown error'}`, 'error');
        }
      } catch (error) {
        console.error('Error updating emoji:', error);
        showToast('Failed to update emoji', 'error');
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      console.log('Setting up event listeners...');

      // Hamburger menu
      const hamburger = document.getElementById('hamburger');
      const nav = document.getElementById('sidebar');
      const closeBtn = document.getElementById('closeSidebar');
      if (hamburger && nav && closeBtn) {
        hamburger.addEventListener('click', () => {
          nav.classList.toggle('translate-x-0');
        });
        closeBtn.addEventListener('click', () => {
          nav.classList.remove('translate-x-0');
        });
      }

      // Logout
      const logoutBtn = document.getElementById('logout');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
          localStorage.removeItem('userId');
          localStorage.removeItem('accessToken');
          window.location.href = '/';
        });
      }

      // Topic modal close
      const closeTopicModalBtn = document.getElementById('closeTopicModal');
      const topicModal = document.getElementById('topicModal');
      if (closeTopicModalBtn && topicModal) {
        closeTopicModalBtn.addEventListener('click', () => {
          const modalContent = document.getElementById('modalContent');
          modalContent.classList.add('opacity-0', 'translate-y-5');
          setTimeout(() => {
            topicModal.classList.add('hidden');
            document.body.style.overflow = '';
          }, 300);
        });
        window.addEventListener('click', (e) => {
          if (e.target === topicModal) {
            closeTopicModalBtn.click();
          }
        });
      }

      // Generate summary
      const generateSummaryBtn = document.getElementById('generateSummaryBtn');
      if (generateSummaryBtn) {
        generateSummaryBtn.addEventListener('click', generateSummary);
      }

      // Save note (in modal)
      const saveNoteBtn = document.getElementById('saveNoteBtn');
      if (saveNoteBtn) {
        saveNoteBtn.addEventListener('click', () => {
          handleSaveNote();
          showToast('Note saving is not fully implemented', 'error');
        });
      }





      // Tab switching
      const modal = document.getElementById('topicModal');
      if (modal) {
        const tabButtons = modal.querySelectorAll('.tab-button');
        const tabContents = modal.querySelectorAll('.tab-content');
        tabButtons.forEach(button => {
          button.addEventListener('click', () => {
            const tabName = button.getAttribute('data-tab');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            tabContents.forEach(content => {
              if (content.id === `${tabName}Tab`) {
                content.classList.remove('hidden');
              } else {
                content.classList.add('hidden');
              }
            });
          });
        });
      }

      // --- Add Topic Modal Functionality (Dashboard) ---
      const showAddTopicModalBtn = document.getElementById('showAddTopicModal');
      const addTopicModal = document.getElementById('addTopicModal');
      const closeAddTopicModalBtn = document.getElementById('closeAddTopicModal');
      const newTopicInputDashboard = document.getElementById('newTopicInputDashboard');
      const submitNewTopicBtn = document.getElementById('submitNewTopicBtn');

      if (showAddTopicModalBtn && addTopicModal && closeAddTopicModalBtn && newTopicInputDashboard && submitNewTopicBtn) {
        showAddTopicModalBtn.addEventListener('click', () => {
          addTopicModal.classList.remove('hidden');
          document.body.style.overflow = 'hidden'; // Prevent background scroll
          const modalContent = document.getElementById('addTopicModalContent');
          modalContent.classList.remove('opacity-0', 'translate-y-5'); // Reset animation classes
        });

        closeAddTopicModalBtn.addEventListener('click', () => {
          const modalContent = document.getElementById('addTopicModalContent');
          modalContent.classList.add('opacity-0', 'translate-y-5');
          setTimeout(() => {
            addTopicModal.classList.add('hidden');
            document.body.style.overflow = '';
          }, 300);
        });

        // Close modal if clicked outside
        window.addEventListener('click', (e) => {
          if (e.target === addTopicModal) {
            closeAddTopicModalBtn.click();
          }
        });

        submitNewTopicBtn.addEventListener('click', async () => {
          const topicName = newTopicInputDashboard.value.trim();
          const userId = localStorage.getItem('userId');
          const accessToken = localStorage.getItem('accessToken');

          if (!topicName) {
            showToast('Please enter a topic name', 'error');
            return;
          }

          if (!userId || !accessToken) {
            showToast('User not authenticated. Please log in.', 'error');
            window.location.href = '/pages/login.html';
            return;
          }

          try {
            showLoadingIndicator();
            const response = await fetch('/.netlify/functions/dashboard', {
              method: 'POST',
              body: JSON.stringify({
                action: 'addTopic',
                userId,
                topicName
              }),
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`
              }
            });

            const result = await response.json(); // Always parse JSON response
            hideLoadingIndicator();

            if (!response.ok) {
              throw new Error(result.error || 'Failed to add topic');
            }

            newTopicInputDashboard.value = ''; // Clear the input
            closeAddTopicModalBtn.click(); // Close the modal

            // Create the new topic card with emoji and add it to the list
            if (result.topicId) {
              const newTopic = {
                id: result.topicId,
                name: topicName,
                emoji: result.emoji || 'ðŸ“š', // Use the returned emoji or default
                conversation_count: 0,
                bookmark_count: 0,
                note_count: 0,
                created_at: new Date().toISOString()
              };

              const topicsList = document.querySelector('.topics-grid');
              if (topicsList) {
                const newCard = createTopicCard(newTopic);
                topicsList.prepend(newCard); // Add to the beginning of the list
                showToast(`Topic "${topicName}" created with ${result.emoji || 'ðŸ“š'} emoji`, 'success');
              } else {
                // Fallback to reloading if we can't find the topics list
                if (typeof loadTopics === 'function') {
                  loadTopics(); 
                } else if (typeof fetchTopics === 'function') {
                  fetchTopics(); // Fallback if loadTopics isn't available
                } else {
                  console.warn('Topics grid not found. Reloading page.');
                  window.location.reload(); // Last resort, reload the page
                }
                showToast(`Topic "${topicName}" created successfully!`, 'success');
              }
            } else {
              // Fallback to traditional refresh if we didn't get a topic ID
              if (typeof loadTopics === 'function') {
                loadTopics(); 
              } else if (typeof fetchTopics === 'function') {
                fetchTopics(); // Fallback if loadTopics isn't available
              } else {
                console.warn('loadTopics or fetchTopics function not found. Reloading page.');
                window.location.reload(); // Last resort, reload the page
              }
              showToast('Topic added successfully!', 'success');
            }
          } catch (error) {
            console.error('Error adding topic:', error);
            showToast(error.message || 'Failed to add topic. Please try again.', 'error');
          }
        });
      }
      // --- End Add Topic Modal Functionality ---

      console.log('Event listeners set up.');
    }

    async function loadTutorAvatar() {
      const userId = localStorage.getItem('userId');
      const accessToken = localStorage.getItem('accessToken');
      const sidebarAvatarImg = document.getElementById('dashboardSidebarUserAvatar');
      const avatarLoading = document.getElementById('avatarLoading');
      
      // Check for cached avatar URL first
      const cachedAvatarUrl = localStorage.getItem('userAvatarUrl');
      
      if (!userId || !accessToken) {
        console.warn('User not authenticated, cannot load avatar.');
        showDefaultAvatar(sidebarAvatarImg, avatarLoading);
        return;
      }

      if (!sidebarAvatarImg) {
        console.error('Sidebar avatar image element not found.');
        return;
      }
      
      // Use cached avatar if available (prevents flashing)
      if (cachedAvatarUrl) {
        sidebarAvatarImg.src = cachedAvatarUrl;
        sidebarAvatarImg.onload = () => {
          sidebarAvatarImg.classList.remove('opacity-0');
          sidebarAvatarImg.classList.add('opacity-100');
          if (avatarLoading) avatarLoading.style.display = 'none';
        };
      }
      
      try {
        // Still fetch fresh avatar from server in case it changed
        const response = await fetch('/.netlify/functions/dashboard', {
          method: 'POST',
          body: JSON.stringify({
            action: 'getAvatar',
            userId: userId
          }),
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          }
        });
        const result = await response.json();
        if (response.ok && result.avatarUrl) {
          // Cache the avatar URL
          localStorage.setItem('userAvatarUrl', result.avatarUrl);
          
          // If URL is different from cached version, update the display
          if (sidebarAvatarImg.src !== result.avatarUrl) {
            sidebarAvatarImg.src = result.avatarUrl;
            sidebarAvatarImg.onload = () => {
              sidebarAvatarImg.classList.remove('opacity-0');
              sidebarAvatarImg.classList.add('opacity-100');
              if (avatarLoading) avatarLoading.style.display = 'none';
            };
          } else if (sidebarAvatarImg.classList.contains('opacity-0')) {
            // In case the image was already loaded but not made visible
            sidebarAvatarImg.classList.remove('opacity-0');
            sidebarAvatarImg.classList.add('opacity-100');
            if (avatarLoading) avatarLoading.style.display = 'none';
          }
        } else {
          throw new Error(result.error || 'Failed to load avatar URL');
        }
      } catch (error) {
        console.error('Error loading tutor avatar:', error);
        // Only show default if there's no cached avatar already displayed
        if (!cachedAvatarUrl) {
          showDefaultAvatar(sidebarAvatarImg, avatarLoading);
        }
      }
    }
    
    // Helper function to display default avatar
    function showDefaultAvatar(imgElement, loadingElement) {
      if (!imgElement) return;
      
      imgElement.src = '../assets/avatars/default.png';
      imgElement.onload = () => {
        imgElement.classList.remove('opacity-0');
        imgElement.classList.add('opacity-100');
        if (loadingElement) loadingElement.style.display = 'none';
      };
    }
  </script>
</body>
</html>
