<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Koda Compass</title>
  <link rel="stylesheet" href="../styles/main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
  <nav>
    <a href="/">Home</a>
    <a class='active' href='/pages/dashboard'>Dashboard</a>
    <a href='/pages/chat'>Chat</a>
    <a href="#" id="logout">Log Out</a>
  </nav>
  <div class="main-content">
    <h1>Your Topics</h1>
    <div id="topics"></div>
  </div>
  <script>
    // Function to check if user is logged in
    function checkLogin() {
      if (!localStorage.getItem('userId')) {
        alert('Please log in first.');
        window.location.href = 'login.html';
      }
    }

    // Run login check when the page loads
    checkLogin();

    console.log('Stored userId:', localStorage.getItem('userId'));

    // Fetch current user to verify (optional, requires session)
    async function verifyUser() {
      try {
        const verifyResponse = await fetch('/.netlify/functions/auth', {
          method: 'POST',
          body: JSON.stringify({ action: 'verify' }),
          headers: { 'Content-Type': 'application/json' }
        });
        const verifyResult = await verifyResponse.json();
        console.log('Verified user:', verifyResult);
      } catch (error) {
        console.error('Error verifying user:', error);
      }
    }

    // Call verifyUser function
    verifyUser();

    async function loadDashboard() {
      const userId = localStorage.getItem('userId');
      console.log('Loading dashboard for userId:', userId);
      try {
        const response = await fetch('/.netlify/functions/dashboard', {
          method: 'POST',
          body: JSON.stringify({ userId }),
          headers: { 'Content-Type': 'application/json' }
        });
        if (!response.ok) throw new Error('Network response was not ok');
        const { topics, bookmarks } = await response.json();
        console.log('Received data:', { topics, bookmarks });
        const topicsDiv = document.getElementById('topics');
        topicsDiv.innerHTML = '<div class="topic-section"><h2>Topics from Bookmarks</h2></div>';
        if (topics && topics.length > 0) {
          topics.forEach(topic => {
            const topicBookmarks = bookmarks.filter(b => b.topic_id === topic.id);
            // Deduplicate bookmarks by URL
            const uniqueBookmarks = [];
            const seenUrls = new Set();
            topicBookmarks.forEach(bookmark => {
              if (!seenUrls.has(bookmark.url)) {
                seenUrls.add(bookmark.url);
                uniqueBookmarks.push(bookmark);
              }
            });
            const topicElem = document.createElement('div');
            topicElem.className = 'topic-card';
            topicElem.innerHTML = `<h3><i class="fas fa-bookmark"></i> ${topic.name}</h3><ul>${uniqueBookmarks.map(b => `<li><i class="fas fa-link"></i> <a href="${b.url}" target="_blank">${b.url}</a></li>`).join('')}</ul>`;
            topicsDiv.appendChild(topicElem);
          });
        } else {
          topicsDiv.innerHTML += '<div class="topic-section"><p>No topics or bookmarks yet.</p></div>';
        }
        topicsDiv.innerHTML += '<div class="topic-section"><h2>Topics from Conversations</h2><p>Coming soon: Topics based on your chat history.</p></div>';
      } catch (error) {
        console.error('Error loading dashboard:', error);
        document.getElementById('topics').innerHTML = `<div class="topic-section"><p>Error loading topics: ${error.message}</p></div>`;
      }
    }

    loadDashboard();

    document.getElementById('logout').addEventListener('click', () => {
      localStorage.removeItem('userId');
      window.location.href = '/';
    });
  </script>
</body>
</html>
