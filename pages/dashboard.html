<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Koda Compass</title>
  <link rel="stylesheet" href="../styles/main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="../scripts/utils.js" defer></script>
  <style>
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    /* Scrollbar styling */
    .tab-content::-webkit-scrollbar {
      width: 6px;
    }

    .tab-content::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .tab-content::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 10px;
    }

    .tab-content::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }

    /* Line clamp for multi-line text truncation */
    .line-clamp-1 {
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-clamp: 1;
    }

    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-clamp: 2;
    }

  </style>
</head>

<body class="bg-gray-50 font-eb-garamond min-h-screen flex text-gray-900">
  <!-- Mobile Hamburger -->
  <div class="md:hidden fixed top-4 left-4 z-50 cursor-pointer p-2" id="hamburger">
    <div class="w-6 h-0.5 bg-gray-800 mb-1"></div>
    <div class="w-6 h-0.5 bg-gray-800 mb-1"></div>
    <div class="w-6 h-0.5 bg-gray-800"></div>
  </div>

  <!-- Sidebar Navigation -->
  <div id="sidebar" class="fixed top-0 left-0 h-screen w-56 bg-blue-50 shadow-md transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-40">
    <div class="flex flex-col h-full">
      <div class="p-5 border-b border-blue-100">
        <h1 class="text-xl font-bold text-gray-800">Koda Compass</h1>
        <button id="closeSidebar" class="absolute top-5 right-4 text-gray-500 hover:text-gray-700 md:hidden">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <nav class="flex-1 overflow-y-auto py-4">
        <ul class="space-y-2 px-4">
          <li id="loggedInNav" class="hidden flex-col space-y-2">
            <a href="dashboard.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg bg-blue-100 text-blue-800">
              <i class="fas fa-compass"></i>
              <span>Dashboard</span>
            </a>
            <a href="chat.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-blue-100 hover:text-blue-800 transition-colors">
              <i class="fas fa-comments"></i>
              <span>Chat</span>
            </a>
            <a href="bookmarks.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-blue-100 hover:text-blue-800 transition-colors">
              <i class="fas fa-bookmark"></i>
              <span>Bookmarks</span>
            </a>
            <a href="#" id="notesToggle" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-blue-100 hover:text-blue-800 transition-colors">
              <i class="fas fa-sticky-note"></i>
              <span>Notes</span>
            </a>
            <a href="settings.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-blue-100 hover:text-blue-800 transition-colors">
              <i class="fas fa-cog"></i>
              <span>Settings</span>
            </a>
          </li>
          <li id="loggedOutNav" class="hidden flex-col space-y-2">
            <a href="login.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-blue-100 hover:text-blue-800 transition-colors">
              <i class="fas fa-sign-in-alt"></i>
              <span>Login</span>
            </a>
            <a href="signup.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-blue-100 hover:text-blue-800 transition-colors">
              <i class="fas fa-user-plus"></i>
              <span>Sign Up</span>
            </a>
          </li>
        </ul>
      </nav>
      
      <div class="p-4 border-t border-blue-100">
        <button id="logout" class="w-full flex items-center justify-center space-x-2 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="flex-1 ml-0 md:ml-56 p-4 md:p-8 min-h-screen">
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">Welcome Back!</h1>
      <p class="text-lg text-gray-600 mb-6">Here are your conversation topics</p>
      <button class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors duration-200" id="showAddTopicModal">
        <i class="fas fa-plus mr-2"></i> New Topic
      </button>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 my-8" id="topicsGrid">
      <!-- Topics will be loaded here -->
      <div class="flex justify-center items-center" id="topicsLoading">
        <div class="relative w-10 h-10 border-2 border-gray-200 rounded-full">
          <div class="absolute top-1/2 left-1/2 w-0.5 h-3.5 bg-gradient-to-b from-red-500 to-red-600 transform-gpu origin-bottom animate-spin"></div>
          <div class="absolute w-1.5 h-1.5 bg-gray-800 rounded-full top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Topic Modal -->
  <div class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden" id="topicModal">
    <div class="bg-white w-11/12 max-w-4xl mx-auto rounded-xl shadow-lg max-h-[90vh] overflow-hidden transition-all duration-300 flex flex-col" id="modalContent">
      <div class="p-6 border-b border-gray-200">
        <div class="flex justify-between items-center">
          <h2 id="modalTopicName" class="text-2xl font-bold text-gray-800"></h2>
          <button id="closeTopicModal" class="text-2xl text-gray-500 hover:text-gray-700">&times;</button>
        </div>
      </div>
      
      <div class="overflow-y-auto flex-1 p-6" style="max-height: 70vh">
        <div class="border-b border-gray-200 mb-6">
          <div class="flex space-x-6">
            <button class="tab-button active" data-tab="conversations">
              <i class="fas fa-comments mr-2"></i> Conversations
            </button>
            <button class="tab-button" data-tab="bookmarks">
              <i class="fas fa-bookmark mr-2"></i> Bookmarks
            </button>
            <button class="tab-button" data-tab="notes">
              <i class="fas fa-sticky-note mr-2"></i> Notes
            </button>
            <button class="tab-button" data-tab="summary">
              <i class="fas fa-magic mr-2"></i> Summary
            </button>
          </div>
        </div>
        
        <div class="tab-content block" id="conversationsTab">
          <div id="conversationsList" class="space-y-4">
            <!-- Conversations will be loaded here -->
            <div class="flex justify-center items-center py-8">
              <i class="fas fa-circle-notch fa-spin fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
        
        <div class="tab-content hidden" id="bookmarksTab">
          <div id="bookmarksList" class="space-y-4">
            <!-- Bookmarks will be loaded here -->
            <div class="flex justify-center items-center py-8">
              <i class="fas fa-circle-notch fa-spin fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
        
        <div class="tab-content hidden" id="notesTab">
          <div id="topicNotesList" class="space-y-4">
            <!-- Notes will be loaded here -->
            <div class="flex justify-center items-center py-8">
              <i class="fas fa-circle-notch fa-spin fa-2x text-gray-300"></i>
            </div>
          </div>
          
          <div class="mt-6">
            <textarea id="newNoteContent" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" rows="4" placeholder="Add a new note..."></textarea>
            <button id="saveNoteBtn" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
              <i class="fas fa-save mr-2"></i> Save Note
            </button>
          </div>
        </div>
        
        <div class="tab-content hidden" id="summaryTab">
          <div class="mb-6">
            <h3 class="text-xl font-semibold mb-2">Topic Summary</h3>
            <p class="text-gray-600 mb-4">Generate a summary to see the key points from all your conversations, bookmarks, and notes in this topic.</p>
            
            <button id="generateSummaryBtn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
              <i class="fas fa-magic mr-2"></i> Generate Summary
            </button>
          </div>
          <div id="summaryLoading" class="hidden flex justify-center items-center py-8">
            <div class="text-center">
              <i class="fas fa-circle-notch fa-spin fa-2x text-gray-300 mb-3"></i>
              <p class="text-gray-500">Generating summary... This may take a moment.</p>
            </div>
          </div>
          <!-- Learning Highlights Section (Card Layout) -->
          <div id="summaryContent" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
            <!-- Cards will be injected here by JS as Tailwind-styled cards -->
          </div>
          <template id="highlightCardTemplate">
            <div class="bg-white rounded-xl shadow-md p-5 flex flex-col justify-between h-full border border-gray-100 hover:shadow-lg transition group">
              <div>
                <div class="font-bold text-lg mb-1 text-blue-700">{{concept}}</div>
                <div class="text-gray-700 mb-2 line-clamp-2">{{description}}</div>
              </div>
              <div class="flex items-center justify-between mt-3">
                <span class="text-xs text-gray-400 font-medium">{{source}}</span>
                <div class="flex gap-2">
                  <button class="revisit-btn px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 font-semibold transition">Revisit</button>
                  <button class="quiz-btn px-3 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200 font-semibold transition">Quiz Me</button>
                </div>
              </div>
            </div>
          </template>
          <div id="summaryMeta" class="mt-4 text-sm text-gray-500 hidden">
            <p>Last updated: <span id="summaryLastUpdated"></span></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Notes Panel -->
  <div id="notesPanel" class="fixed top-0 right-0 w-96 h-screen bg-white shadow-lg z-50 flex flex-col border-l border-gray-200 transform translate-x-full transition-transform duration-300 ease-in-out">
    <div class="flex justify-between items-center p-5 bg-gray-50 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
        <i class="fas fa-sticky-note text-yellow-400"></i> Quick Notes
      </h2>
      <button class="text-2xl text-gray-500 hover:text-gray-700 transition-colors" id="closeNotesBtn">&times;</button>
    </div>
    
    <div class="flex-1 flex flex-col overflow-hidden">
      <div class="p-5 border-b border-gray-200">
        <textarea id="noteText" placeholder="Jot down a thought..." class="w-full h-24 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400 focus:border-transparent resize-none transition-all duration-200 font-eb-garamond"></textarea>
        <div class="flex gap-3 mt-4">
          <select id="noteTopic" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400 focus:border-transparent text-sm">
            <option value="">Untagged</option>
            <!-- Topics will be loaded here -->
          </select>
          <button id="saveNote" class="bg-yellow-400 hover:bg-yellow-500 text-gray-800 px-4 py-2 rounded-lg transition-colors duration-200 flex items-center gap-2 font-medium">
            <i class="fas fa-save"></i> Save
          </button>
        </div>
      </div>
      
      <div class="flex justify-between items-center p-4 border-b border-gray-200">
        <h3 class="font-medium text-gray-800">Saved Notes</h3>
        <select id="noteFilter" class="p-1.5 text-sm border border-gray-300 rounded-lg">
          <option value="all">All Notes</option>
          <option value="untagged">Untagged</option>
          <!-- Topics will be loaded here -->
        </select>
      </div>
      
      <div id="notesList" class="flex-1 overflow-y-auto p-4">
        <!-- Notes will be loaded here -->
      </div>
    </div>
  </div>
  
  <!-- Audio for success sound -->
  <audio id="saveSuccessSound" preload="auto" src="../sounds/success-chime.mp3"></audio>

  <!-- Loading Spinner Template -->
  <template id="loadingSpinnerTemplate">
    <div class="flex justify-center items-center py-8">
      <div class="relative w-10 h-10 border-2 border-gray-200 rounded-full">
        <div class="absolute top-1/2 left-1/2 w-0.5 h-3.5 bg-gradient-to-b from-green-500 to-green-600 transform-gpu origin-bottom animate-spin"></div>
        <div class="absolute w-1.5 h-1.5 bg-gray-800 rounded-full top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></div>
      </div>
    </div>
  </template>
  
  <!-- Empty State Template -->
  <template id="emptyStateTemplate">
    <div class="text-center py-10">
      <div class="text-gray-400 mb-3">
        <i class="fas fa-folder-open text-4xl"></i>
      </div>
      <h3 class="text-lg font-medium text-gray-700 mb-1">No items found</h3>
      <p class="text-gray-500 text-sm">There are no items to display.</p>
    </div>
  </template>

  <script>
    // Global variables
    let topics = [];
    let currentTopicId = null;
    
    // Defensive: Prevent JS errors from blocking summary loading
    if (typeof loadNotes !== 'function') {
      window.loadNotes = function() { console.warn('loadNotes() is not implemented on this page.'); };
    }
    if (typeof setupEventListeners !== 'function') {
      window.setupEventListeners = function() { console.warn('setupEventListeners() is not implemented on this page.'); };
    }

    // Document ready function
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM fully loaded');
      
      // Check if user is logged in
      const userId = localStorage.getItem('userId');
      const accessToken = localStorage.getItem('accessToken');
      
      if (!userId || !accessToken) {
        console.log('User not logged in, redirecting');
        window.location.href = '/';
        return;
      }
      
      // Update navigation
      updateNavigation();
      
      // Load topics
      loadTopics();
      
      // Add event listeners
      setupEventListeners();
    });
    
    // Function to load topics
    async function loadTopics() {
      console.log('Loading topics...');
      
      const topicsGrid = document.getElementById('topicsGrid');
      const topicsLoading = document.getElementById('topicsLoading');
      
      if (!topicsGrid) {
        console.error('Topics grid not found');
        return;
      }
      
      try {
        const userId = localStorage.getItem('userId');
        const accessToken = localStorage.getItem('accessToken');
        
        // Show loading
        if (topicsLoading) {
          topicsLoading.style.display = 'flex';
        }
        
        // Make API call
        const response = await fetch('/.netlify/functions/dashboard', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          },
          body: JSON.stringify({
            action: 'getTopics',
            userId
          })
        });
        
        if (!response.ok) {
          throw new Error(`Server responded with status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('Topics loaded:', result);
        
        // Hide loading
        if (topicsLoading) {
          topicsLoading.style.display = 'none';
        }
        
        // Clear existing topics
        Array.from(topicsGrid.children).forEach(child => {
          if (child.id !== 'topicsLoading') {
            child.remove();
          }
        });
        
        // Store topics
        topics = result.topics || [];
        
        if (topics.length === 0) {
          // Show empty state
          const emptyState = document.createElement('div');
          emptyState.className = 'col-span-3 text-center py-8';
          emptyState.innerHTML = `
            <div class="text-center py-8">
              <i class="fas fa-book text-gray-300 text-6xl mb-4"></i>
              <h3 class="text-xl font-semibold text-gray-700 mb-2">No topics yet</h3>
              <p class="text-gray-500 mb-4">Create your first topic to get started!</p>
              <button class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors duration-200" id="createFirstTopic">
                <i class="fas fa-plus mr-2"></i> Create Topic
              </button>
            </div>
          `;
          
          topicsGrid.appendChild(emptyState);
          
          // Add event listener 
          document.getElementById('createFirstTopic')?.addEventListener('click', () => {
            document.getElementById('showAddTopicModal').click();
          });
        } else {
          // Display topics
          topics.forEach((topic, index) => {
            const card = createTopicCard(topic);
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            topicsGrid.appendChild(card);
            
            // Add animation
            setTimeout(() => {
              card.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
              card.style.opacity = '1';
              card.style.transform = 'translateY(0)';
            }, index * 100);
          });
        }
      } catch (error) {
        console.error('Error loading topics:', error);
        
        // Hide loading
        if (topicsLoading) {
          topicsLoading.style.display = 'none';
        }
        
        // Show error
        const errorState = document.createElement('div');
        errorState.className = 'col-span-3 text-center py-8';
        errorState.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-exclamation-circle text-red-500 text-4xl mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">Error loading topics</h3>
            <p class="text-gray-500 mb-4">${error.message || 'Please try again later'}</p>
            <button class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors" id="retryLoadTopics">
              <i class="fas fa-redo mr-2"></i> Retry
            </button>
          </div>
        `;
        
        topicsGrid.appendChild(errorState);
        
        // Add retry event listener
        document.getElementById('retryLoadTopics')?.addEventListener('click', loadTopics);
      }
    }
    
    // Check if user is logged in
    const userId = localStorage.getItem('userId');
    const accessToken = localStorage.getItem('accessToken');
    
    // Check login status and update navigation
    function updateNavigation() {
      const isLoggedIn = userId && accessToken;
      const loggedInNav = document.getElementById('loggedInNav');
      const loggedOutNav = document.getElementById('loggedOutNav');
      
      if (isLoggedIn) {
        loggedInNav.style.display = 'block';
        loggedOutNav.style.display = 'none';
      } else {
        loggedInNav.style.display = 'none';
        loggedOutNav.style.display = 'block';
        // Redirect to login page if not logged in
        window.location.href = '/pages/login.html';
      }
    }

    // Hamburger menu toggle
    const hamburger = document.getElementById('hamburger');
    const nav = document.getElementById('sidebar');
    const closeBtn = document.getElementById('closeSidebar');

    hamburger.addEventListener('click', () => {
      nav.classList.toggle('translate-x-0');
    });

    closeBtn.addEventListener('click', () => {
      nav.classList.remove('translate-x-0');
    });

    // Logout functionality
    document.getElementById('logout').addEventListener('click', () => {
      localStorage.removeItem('userId');
      localStorage.removeItem('accessToken');
      window.location.href = '/';
    });
    
    // Setup Add Topic Modal functionality
    const addTopicModal = document.getElementById('addTopicModal');
    const closeAddTopicModal = document.querySelector('#addTopicModal .close-modal');
    const addTopicForm = document.getElementById('addTopicForm');
    const showAddTopicModalBtn = document.getElementById('showAddTopicModal');
    
    if (showAddTopicModalBtn) {
      showAddTopicModalBtn.addEventListener('click', () => {
        if (addTopicModal) {
          addTopicModal.classList.add('active');
          document.getElementById('newTopicName').focus();
        }
      });
    }
    
    if (closeAddTopicModal) {
      closeAddTopicModal.addEventListener('click', () => {
        addTopicModal.classList.remove('active');
      });
    }
    
    if (addTopicForm) {
      addTopicForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const topicName = document.getElementById('newTopicName').value.trim();
        if (!topicName) return;
        
        const submitButton = addTopicForm.querySelector('button[type="submit"]');
        const originalText = submitButton.textContent;
        
        // Show loading state
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        submitButton.disabled = true;

        const userId = localStorage.getItem('userId');
        const accessToken = localStorage.getItem('accessToken');

        try {
          const response = await fetch('/.netlify/functions/dashboard', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({
              action: 'addTopic',
              userId,
              name: topicName
            })
          });
          
          const result = await response.json();
          
          if (response.ok) {
            // Success animation
            submitButton.innerHTML = '<i class="fas fa-check"></i>';
            submitButton.classList.add('success');
            
            setTimeout(() => {
              addTopicModal.classList.remove('active');
              submitButton.textContent = originalText;
              submitButton.classList.remove('success');
              submitButton.disabled = false;
            
              // Show success toast
              showToast('Topic created successfully!', 'success');
              
              // Reload topics with animation
              loadTopics();
            }, 1000);
          } else {
            submitButton.textContent = originalText;
            submitButton.disabled = false;
            showToast('Failed to create topic: ' + result.error, 'error');
          }
        } catch (error) {
          console.error('Error creating topic:', error);
          submitButton.textContent = originalText;
          submitButton.disabled = false;
          showToast('Error connecting to server. Please try again.', 'error');
        }
      });
    }
    
    // Notes toggle functionality
    const notesToggle = document.getElementById('notesToggle');
    const notesPanel = document.getElementById('notesPanel');
    const closeNotes = document.getElementById('closeNotesBtn');
    
    if (notesToggle && notesPanel && closeNotes) {
      notesToggle.addEventListener('click', (e) => {
        e.preventDefault();
        notesPanel.classList.toggle('translate-x-full');
        if (!notesPanel.classList.contains('translate-x-full')) {
          loadNotesTopics();
          loadNotes();
        }
      });
      
      closeNotes.addEventListener('click', () => {
        notesPanel.classList.add('translate-x-full');
      });
    }
    
    // Set up save note functionality
    const saveNoteBtn = document.getElementById('saveNote');
    if (saveNoteBtn) {
      saveNoteBtn.addEventListener('click', saveNote);
    }
    
    // Set up note filter change event
    const noteFilter = document.getElementById('noteFilter');
    if (noteFilter) {
      noteFilter.addEventListener('change', loadNotes);
    }

    // Modal functionality
    const modal = document.getElementById('topicModal');
    const closeModal = document.querySelector('.close-modal');
    
    if (modal && closeModal) {
      closeModal.addEventListener('click', () => {
        // Add exit animation
        const modalContent = document.getElementById('modalContent');
        modalContent.classList.add('animate-fade-out');
        
        setTimeout(() => {
          modal.classList.remove('active');
          modalContent.classList.remove('animate-fade-out', 'animate-scale');
        }, 300);
      });

      window.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeModal.click();
        }
      });
    }

    // Delete topic button
    const deleteTopicBtn = document.getElementById('deleteTopic');
    if (deleteTopicBtn) {
      deleteTopicBtn.addEventListener('click', async () => {
        if (!currentTopicId) return;
        
        // Show confirmation with animation
        const deleteButton = document.getElementById('deleteTopic');
        const originalText = deleteButton.innerHTML;
        
        deleteButton.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Confirm Delete?';
        deleteButton.classList.add('confirm-delete');
        
        // Create cancel option
        const cancelButton = document.createElement('button');
        cancelButton.className = 'btn-secondary cancel-delete animate-[fadeIn_0.3s_ease-out_forwards]';
        cancelButton.innerHTML = 'Cancel';
        deleteButton.parentNode.insertBefore(cancelButton, deleteButton.nextSibling);
        
        // Handle cancel
        cancelButton.addEventListener('click', () => {
          deleteButton.innerHTML = originalText;
          deleteButton.classList.remove('confirm-delete');
          cancelButton.classList.add('animate-[fadeOut_0.3s_ease-out_forwards]');
          setTimeout(() => cancelButton.remove(), 300);
        });
        
        // Handle confirmation
        function handleDeleteConfirm() {
          // Remove listeners
          deleteButton.removeEventListener('click', handleDeleteConfirm);
          
          // Show loading state
          deleteButton.innerHTML = '<span class="loading-spinner w-5 h-5"></span>';
          deleteButton.disabled = true;
          cancelButton.remove();
          
          deleteTopic(currentTopicId);
        }
        
        // Add confirmation listener
        deleteButton.addEventListener('click', handleDeleteConfirm);
      });
    }
    
    // Function to create topic cards
    function createTopicCard(topic) {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow duration-200 overflow-hidden cursor-pointer';
      card.id = `topic-${topic.id}`;
      card.dataset.topicId = topic.id;
      
      // Format date
      const createdDate = new Date(topic.created_at);
      const formattedDate = createdDate.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });
      
      card.innerHTML = `
        <div class="p-5">
          <div class="flex justify-between items-start mb-3">
            <h3 class="text-lg font-semibold text-gray-800 line-clamp-1">${topic.name}</h3>
            <div class="dropdown relative">
              <button class="text-gray-400 hover:text-gray-600 transition-colors p-1 rounded-full hover:bg-gray-100 topic-menu-btn">
                <i class="fas fa-ellipsis-v"></i>
              </button>
              <div class="dropdown-menu hidden absolute right-0 mt-1 bg-white shadow-lg rounded-lg overflow-hidden z-10 w-48 border border-gray-200">
                <button class="w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100 transition-colors flex items-center gap-2 relative rename-topic" data-id="${topic.id}">
                  <i class="fas fa-edit text-blue-500"></i> Rename
                </button>
                <button class="w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100 transition-colors flex items-center gap-2 relative delete-topic" data-id="${topic.id}">
                  <i class="fas fa-trash-alt text-red-500"></i> Delete
                </button>
              </div>
            </div>
          </div>
          <p class="text-gray-600 text-sm mb-4">${topic.description || 'No description'}</p>
          <div class="flex justify-between items-center text-xs text-gray-500">
            <span><i class="fas fa-calendar-alt mr-1"></i> ${formattedDate}</span>
            <span><i class="fas fa-comment mr-1"></i> ${topic.conversation_count || 0} conversation${topic.conversation_count !== 1 ? 's' : ''}</span>
          </div>
        </div>
      `;
      
      // Add click event listener to open modal
      card.addEventListener('click', (e) => {
        if (!e.target.closest('.dropdown')) {
          openTopicModal(topic.id);
        }
      });
      
      // Menu toggle
      const menuBtn = card.querySelector('.topic-menu-btn');
      const dropdownMenu = card.querySelector('.dropdown-menu');
      
      menuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdownMenu.classList.toggle('hidden');
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', () => {
        dropdownMenu.classList.add('hidden');
      });
      
      // Rename topic
      const renameBtn = card.querySelector('.rename-topic');
      renameBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const topicId = e.currentTarget.getAttribute('data-id');
        const topicName = topic.name;
        const newName = prompt('Enter new topic name:', topicName);
        
        if (newName && newName !== topicName) {
          renameTopic(topicId, newName);
        }
      });
      
      // Delete topic
      const deleteBtn = card.querySelector('.delete-topic');
      deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const topicId = e.currentTarget.getAttribute('data-id');
        if (confirm(`Are you sure you want to delete "${topic.name}"? This will delete all conversations, bookmarks, and notes in this topic.`)) {
          deleteTopic(topicId);
        }
      });
      
      return card;
    }

    // Function to open topic modal
    function openTopicModal(topicId) {
      console.log('Opening topic modal for:', topicId);
      
      const userId = localStorage.getItem('userId');
      const accessToken = localStorage.getItem('accessToken');
      
      if (!userId || !accessToken) {
        window.location.href = '/';
        return;
      }
      
      const topicModal = document.getElementById('topicModal');
      const modalContent = document.getElementById('modalContent');
      const modalTopicName = document.getElementById('modalTopicName');
      const summaryContent = document.getElementById('summaryContent');
      
      // Clear any existing summary content to prevent showing stale data
      if (summaryContent) {
        summaryContent.innerHTML = '';
      }
      
      // Set the topic ID on the modal for later use (especially for summary generation)
      topicModal.setAttribute('data-topic-id', topicId);
      
      // Get topic data
      const topic = topics.find(t => t.id === topicId);
      if (!topic) {
        console.error('Topic not found:', topicId);
        return;
      }
      
      // Set topic name in modal
      modalTopicName.textContent = topic.name;
      
      // Show modal with animation
      topicModal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      
      // Add entrance animation
      setTimeout(() => {
        modalContent.classList.remove('opacity-0', 'translate-y-5');
      }, 10);
      
      // Reset tabs to conversations tab
      const tabBtns = document.querySelectorAll('[data-tab]'); 
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabBtns.forEach(btn => {
        btn.classList.remove('active');
      });
      
      tabContents.forEach(content => {
        content.classList.add('hidden');
      });
      
      // Set conversations tab as active
      document.querySelector('[data-tab="conversations"]').classList.add('active');
      document.getElementById('conversationsTab').classList.remove('hidden');
      
      // Load data for this topic
      currentTopicId = topicId;
      loadConversations(topicId);
      loadBookmarks(topicId);
      
      // Only call loadTopicNotes if it exists
      if (typeof loadTopicNotes === 'function') {
        loadTopicNotes(topicId);
      }
      
      loadTopicSummary(topicId); 
    }

    // Function to load existing summary for a topic
    async function loadTopicSummary(topicId) {
      console.log('[DEBUG] Calling loadTopicSummary for topic:', topicId);
      const userId = localStorage.getItem('userId');
      const accessToken = localStorage.getItem('accessToken');
      const summaryContent = document.getElementById('summaryContent');
      const summaryLoading = document.getElementById('summaryLoading');

      if (!summaryContent) {
        console.error('Summary content container not found');
        return;
      }

      // Show loading state
      if (summaryLoading) summaryLoading.style.display = 'flex';
      summaryContent.style.display = 'none';

      try {
        console.log(`[DEBUG] Fetching summary for topic_id: ${topicId}, user_id: ${userId}`);
        const response = await fetch('/.netlify/functions/summary', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          },
          body: JSON.stringify({
            action: 'getSummary',  // Important: this tells the backend what to do
            topic_id: topicId,     // Must match parameter names in the database schema
            user_id: userId
          })
        });
        
        console.log('[DEBUG] Summary API response status:', response.status);
        const result = await response.json();
        console.log('[DEBUG] Summary API result:', result);
        
        if (!response.ok) {
          throw new Error(result.error || 'Failed to fetch summary');
        }
        
        // Always hide loading state
        if (summaryLoading) summaryLoading.style.display = 'none';
        
        if (result.summary && result.summary.highlights && result.summary.highlights.length > 0) {
          const highlightCards = result.summary.highlights.map(highlight => {
            const template = document.getElementById('highlightCardTemplate');
            const clone = template.content.cloneNode(true);
            clone.querySelector('.font-bold').textContent = highlight.concept;
            clone.querySelector('.text-gray-700').textContent = highlight.description;
            clone.querySelector('.text-xs').textContent = highlight.source;
            return clone;
          });
          summaryContent.innerHTML = '';
          highlightCards.forEach(card => summaryContent.appendChild(card));
          summaryContent.style.display = 'block';
          
          // Show last updated time if available
          const summaryMeta = document.getElementById('summaryMeta');
          const summaryLastUpdated = document.getElementById('summaryLastUpdated');
          
          if (summaryMeta && summaryLastUpdated && result.summary.created_at) {
            summaryLastUpdated.textContent = formatDate(result.summary.created_at);
            summaryMeta.style.display = 'block';
          }
        } else {
          summaryContent.innerHTML = '<p class="text-gray-500">No summary found for this topic. Click Generate Summary to create one!</p>';
          summaryContent.style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading summary:', error);
        if (summaryLoading) summaryLoading.style.display = 'none';
        summaryContent.innerHTML = `<p class="text-red-500">Error loading summary: ${error.message}</p>`;
        summaryContent.style.display = 'block';
      }
    }

    // Helper function to format dates consistently
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return 'Invalid date';
      return date.toLocaleString();
    }

    // Close Topic Modal
    const closeTopicModalBtn = document.getElementById('closeTopicModal');
    const topicModal = document.getElementById('topicModal');
    
    if (closeTopicModalBtn && topicModal) {
      closeTopicModalBtn.addEventListener('click', () => {
        console.log('Close button clicked');
        const modalContent = document.getElementById('modalContent');
        
        // Add exit animation
        modalContent.classList.add('opacity-0', 'translate-y-5');
        
        // Hide modal after animation
        setTimeout(() => {
          topicModal.classList.add('hidden');
          document.body.style.overflow = '';
        }, 300);
      });
    }
    
    // Generate or regenerate summary function
    async function generateSummary() {
      console.log('[Debug] Starting summary generation...');
      const summaryContent = document.getElementById('summaryContent');
      const summaryLoading = document.getElementById('summaryLoading');
      const summaryMeta = document.getElementById('summaryMeta');
      const generateBtn = document.getElementById('generateSummaryBtn');
      
      // Get the topic ID from the modal - this is crucial!
      const topicId = document.getElementById('topicModal').getAttribute('data-topic-id');
      console.log('[Debug] Topic ID from modal attribute:', topicId);
      
      if (!topicId) {
        showToast('Could not determine topic ID', 'error');
        return;
      }
      
      // Show loading state
      generateBtn.disabled = true;
      generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
      summaryContent.style.display = 'none';
      if (summaryLoading) {
        summaryLoading.style.display = 'flex';
      }
      if (summaryMeta) {
        summaryMeta.style.display = 'none';
      }
      
      const userId = localStorage.getItem('userId');
      const accessToken = localStorage.getItem('accessToken');
      
      console.log('[Debug] User ID:', userId);
      console.log('[Debug] Making API request with params:', { action: 'generateSummary', user_id: userId, topic_id: topicId });
      
      try {
        // IMPORTANT: Use user_id and topic_id as parameter names to match Supabase schema
        const response = await fetch('/.netlify/functions/summary', {
          method: 'POST',
          body: JSON.stringify({
            action: 'generateSummary',
            topic_id: topicId,
            user_id: userId
          }),
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          }
        });
        
        console.log('[Debug] API Response Status:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('[Debug] API Error Response:', errorText);
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('[Debug] Summary generation response:', result);
        
        if (result.summary) {
          const highlightCards = result.summary.highlights.map(highlight => {
            const template = document.getElementById('highlightCardTemplate');
            const clone = template.content.cloneNode(true);
            clone.querySelector('.font-bold').textContent = highlight.concept;
            clone.querySelector('.text-gray-700').textContent = highlight.description;
            clone.querySelector('.text-xs').textContent = highlight.source;
            return clone;
          });
          summaryContent.innerHTML = '';
          highlightCards.forEach(card => summaryContent.appendChild(card));
          summaryContent.style.display = 'block';
          
          // Show the last updated timestamp
          if (summaryMeta && result.summary.last_source_updated_at) {
            const lastUpdatedEl = document.getElementById('summaryLastUpdated');
            if (lastUpdatedEl) {
              lastUpdatedEl.textContent = formatDate(result.summary.last_source_updated_at);
              summaryMeta.style.display = 'block';
            }
          }
          
          showToast('Summary generated successfully', 'success');
        } else {
          const errorMessage = result.error || 'Unknown error';
          console.error('[Debug] Summary generation error:', errorMessage);
          
          if (result.details) {
            console.error('[Debug] Error details:', result.details);
          }
          
          summaryContent.innerHTML = `<p class="text-red-500">Failed to generate summary: ${errorMessage}</p>`;
          summaryContent.style.display = 'block';
          showToast(`Summary generation failed: ${errorMessage}`, 'error');
        }
      } catch (error) {
        console.error('[Debug] Error generating summary:', error);
        summaryContent.innerHTML = `<p class="text-red-500">Error connecting to server. Please try again.</p>`;
        summaryContent.style.display = 'block';
        showToast('Network error. Please check your internet connection.', 'error');
      } finally {
        // Reset UI
        if (summaryLoading) {
          summaryLoading.style.display = 'none';
        }
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<i class="fas fa-magic"></i> Generate Summary';
      }
    }

    // Initialize everything when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Check authentication
      const userId = localStorage.getItem('userId');
      const accessToken = localStorage.getItem('accessToken');
      
      if (!userId || !accessToken) {
        window.location.href = '/';
        return;
      }
      
      // Load topics
      loadTopics();
      
      // Add event listener to generate summary button
      const generateSummaryBtn = document.getElementById('generateSummaryBtn');
      if (generateSummaryBtn) {
        generateSummaryBtn.addEventListener('click', generateSummary);
        console.log('Added event listener to Generate Summary button');
      }
      
      // Add event listener for new topic button
      const newTopicBtn = document.getElementById('newTopicBtn');
      if (newTopicBtn) {
        newTopicBtn.addEventListener('click', () => {
          const topicName = prompt('Enter a name for the new topic:');
          if (topicName && topicName.trim()) {
            createNewTopic(topicName.trim());
          }
        });
      }
    });

    // Add click handlers for topic modal tabs
    document.addEventListener('DOMContentLoaded', function() {
      // Get all tab buttons
      const tabButtons = document.querySelectorAll('[data-tab]'); 
      
      // Add click event to each tab button
      tabButtons.forEach(button => {
        button.addEventListener('click', function() {
          console.log('Tab clicked:', this.getAttribute('data-tab'));
          
          // Remove active class from all buttons
          tabButtons.forEach(btn => btn.classList.remove('active'));
          
          // Add active class to clicked button
          this.classList.add('active');
          
          // Hide all tab contents
          const tabContents = document.querySelectorAll('.tab-content');
          tabContents.forEach(content => content.classList.add('hidden'));
          
          // Show the selected tab content
          const selectedTab = document.getElementById(this.getAttribute('data-tab') + 'Tab');
          if (selectedTab) {
            selectedTab.classList.remove('hidden');
            selectedTab.classList.add('block');
          }
        });
      });
      
      // Close modal button
      const closeModalBtn = document.getElementById('closeTopicModal');
      if (closeModalBtn) {
        closeModalBtn.addEventListener('click', function() {
          const modal = document.getElementById('topicModal');
          if (modal) {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
          }
        });
      }
      
      // Generate summary button
      const generateSummaryBtn = document.getElementById('generateSummaryBtn');
      if (generateSummaryBtn) {
        generateSummaryBtn.addEventListener('click', function() {
          console.log('Generate summary button clicked');
          
          // Get the topic ID from the modal
          const topicId = document.getElementById('topicModal').getAttribute('data-topic-id');
          if (!topicId) {
            console.error('No topic ID found on modal');
            return;
          }
          
          // Show loading state
          this.disabled = true;
          this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
          
          const summaryContent = document.getElementById('summaryContent');
          const summaryLoading = document.getElementById('summaryLoading');
          
          if (summaryContent) summaryContent.style.display = 'none';
          if (summaryLoading) summaryLoading.style.display = 'flex';
          
          // Make the API request
          const userId = localStorage.getItem('userId');
          const accessToken = localStorage.getItem('accessToken');
          
          fetch('/.netlify/functions/summary', {
            method: 'POST',
            body: JSON.stringify({
              action: 'generateSummary',
              user_id: userId,
              topic_id: topicId
            }),
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            }
          })
          .then(response => {
            if (!response.ok) {
              return response.text().then(text => {
                throw new Error(`HTTP error! status: ${response.status}, message: ${text}`);
              });
            }
            return response.json();
          })
          .then(data => {
            // Update the UI with the summary
            if (summaryContent) {
              if (data.summary) {
                const highlightCards = data.summary.highlights.map(highlight => {
                  const template = document.getElementById('highlightCardTemplate');
                  const clone = template.content.cloneNode(true);
                  clone.querySelector('.font-bold').textContent = highlight.concept;
                  clone.querySelector('.text-gray-700').textContent = highlight.description;
                  clone.querySelector('.text-xs').textContent = highlight.source;
                  return clone;
                });
                summaryContent.innerHTML = '';
                highlightCards.forEach(card => summaryContent.appendChild(card));
                showToast('Summary generated successfully', 'success');
              } else {
                summaryContent.innerHTML = '<p class="text-red-500">No summary data returned</p>';
              }
              summaryContent.style.display = 'block';
            }
          })
          .catch(error => {
            console.error('Error generating summary:', error);
            if (summaryContent) {
              summaryContent.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
              summaryContent.style.display = 'block';
            }
            showToast('Error generating summary', 'error');
          })
          .finally(() => {
            // Reset UI
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-magic"></i> Generate Summary';
            if (summaryLoading) summaryLoading.style.display = 'none';
          });
        });
      }
    });

    // Load conversations for a topic
    async function loadConversations(topicId) {
      const userId = localStorage.getItem('userId');
      const accessToken = localStorage.getItem('accessToken');
      const conversationsList = document.getElementById('conversationsList');
      if (!conversationsList) {
        console.error('Conversations list container not found');
        return;
      }
      // Show loading state
      conversationsList.innerHTML = `
        <div class="flex justify-center items-center py-8">
          <i class="fas fa-circle-notch fa-spin fa-2x text-gray-300"></i>
        </div>
      `;
      try {
        const response = await fetch('/.netlify/functions/dashboard', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          },
          body: JSON.stringify({
            action: 'getTopicDetails',
            userId,
            topicId
          })
        });
        if (!response.ok) {
          throw new Error(`Server responded with status: ${response.status}`);
        }
        const result = await response.json();
        if (result.conversations && result.conversations.length > 0) {
          conversationsList.innerHTML = '';
          result.conversations.forEach(conversation => {
            const conversationItem = document.createElement('div');
            conversationItem.className = 'rounded-lg mb-4 p-4 bg-white shadow-sm transition-shadow duration-200 hover:shadow-md';
            // Truncate long content (300 characters)
            const fullContent = conversation.content;
            const isTruncated = fullContent.length > 300;
            const displayContent = isTruncated ? fullContent.substring(0, 300) + '...' : fullContent;
            conversationItem.innerHTML = `
              <div class="flex justify-between items-start mb-2">
                <span class="text-sm text-gray-500">${new Date(conversation.created_at).toLocaleDateString()}</span>
                <button class="delete-conversation-btn text-red-500 hover:text-red-700 transition-colors" data-id="${conversation.id}">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
              <div class="conversation-content">
                <p class="text-gray-700 whitespace-pre-wrap">${displayContent}</p>
                ${isTruncated ? 
                  `<button class="text-blue-500 hover:text-blue-700 text-sm mt-2 show-more-btn">Show more</button>
                   <div class="full-content hidden">
                     <div class="max-h-96 overflow-y-auto pr-2 my-2">
                       <p class="text-gray-700 whitespace-pre-wrap">${fullContent}</p>
                     </div>
                     <button class="text-blue-500 hover:text-blue-700 text-sm mt-2 show-less-btn">Show less</button>
                   </div>` 
                  : ''}
              </div>
            `;
            conversationsList.appendChild(conversationItem);
            // Add event listeners for show more/less buttons
            if (isTruncated) {
              const showMoreBtn = conversationItem.querySelector('.show-more-btn');
              const showLessBtn = conversationItem.querySelector('.show-less-btn');
              const truncatedContent = conversationItem.querySelector('.conversation-content > p');
              const fullContentDiv = conversationItem.querySelector('.full-content');
              showMoreBtn.addEventListener('click', () => {
                truncatedContent.classList.add('hidden');
                showMoreBtn.classList.add('hidden');
                fullContentDiv.classList.remove('hidden');
              });
              showLessBtn.addEventListener('click', () => {
                truncatedContent.classList.remove('hidden');
                showMoreBtn.classList.remove('hidden');
                fullContentDiv.classList.add('hidden');
              });
            }
            // Add delete event listener
            conversationItem.querySelector('.delete-conversation-btn').addEventListener('click', (e) => {
              e.stopPropagation();
              const conversationId = e.currentTarget.getAttribute('data-id');
              if (confirm('Are you sure you want to delete this conversation?')) {
                deleteConversation(conversationId);
              }
            });
          });
        } else {
          conversationsList.innerHTML = `
            <div class="flex flex-col items-center justify-center py-12 text-gray-400 text-center">
              <i class="fas fa-comment text-4xl mb-4"></i>
              <p>No conversations in this topic yet.</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading conversations:', error);
        conversationsList.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-exclamation-circle text-red-500 text-4xl mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">Error loading conversations</h3>
            <p class="text-gray-500 mb-4">${error.message || 'Please try again later'}</p>
          </div>
        `;
      }
    }

    // Load bookmarks for a topic
    async function loadBookmarks(topicId) {
      const userId = localStorage.getItem('userId');
      const accessToken = localStorage.getItem('accessToken');
      const bookmarksList = document.getElementById('bookmarksList');
      if (!bookmarksList) {
        console.error('Bookmarks list container not found');
        return;
      }
      // Show loading state
      bookmarksList.innerHTML = `
        <div class="flex justify-center items-center py-8">
          <i class="fas fa-circle-notch fa-spin fa-2x text-gray-300"></i>
        </div>
      `;
      try {
        const response = await fetch('/.netlify/functions/dashboard', {
          method: 'POST',
          body: JSON.stringify({
            action: 'getTopicDetails',
            userId,
            topicId
          }),
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          }
        });
        if (!response.ok) {
          throw new Error(`Server responded with status: ${response.status}`);
        }
        const result = await response.json();
        if (result.bookmarks && result.bookmarks.length > 0) {
          bookmarksList.innerHTML = '';
          result.bookmarks.forEach(bookmark => {
            const bookmarkItem = document.createElement('div');
            bookmarkItem.className = 'rounded-lg mb-4 p-4 bg-white shadow-sm transition-shadow duration-200 hover:shadow-md';
            bookmarkItem.innerHTML = `
              <div class="bookmark-header">
                <span class="bookmark-date">${new Date(bookmark.created_at).toLocaleDateString()}</span>
              </div>
              <div class="bookmark-content">
                <a href="${bookmark.url}" target="_blank" class="bookmark-link">
                  <i class="fas fa-external-link-alt"></i> ${bookmark.url}
                </a>
              </div>
            `;
            bookmarksList.appendChild(bookmarkItem);
          });
        } else {
          bookmarksList.innerHTML = `
            <div class="flex flex-col items-center justify-center py-12 text-gray-400 text-center">
              <i class="fas fa-bookmark text-4xl mb-4"></i>
              <p>No bookmarks in this topic yet.</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading bookmarks:', error);
        bookmarksList.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-exclamation-circle text-red-500 text-4xl mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">Error loading bookmarks</h3>
            <p class="text-gray-500 mb-4">${error.message || 'Please try again later'}</p>
          </div>
        `;
      }
    }
  </script>
  
  <!-- Delete a conversation -->
  <script>
    // Delete a conversation
    async function deleteConversation(conversationId) {
      const accessToken = localStorage.getItem('accessToken');
      
      try {
        // Show loading toast
        showToast('Deleting conversation...', 'info');
        
        // Send delete request to API
        const response = await fetch('/.netlify/functions/chatgpt', {
          method: 'POST',
          body: JSON.stringify({
            action: 'deleteConversation',
            conversationId
          }),
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          }
        });
        
        const result = await response.json();
        
        if (response.ok) {
          showToast('Conversation deleted successfully', 'success');
          // Reload the current topic to refresh the conversation list
          const currentTopicId = document.querySelector('.topic-modal').getAttribute('data-topic-id');
          if (currentTopicId) {
            loadConversations(currentTopicId);
          }
        } else {
          showToast('Error: ' + (result.error || 'Failed to delete conversation'), 'error');
        }
      } catch (error) {
        console.error('Error deleting conversation:', error);
        showToast('Error connecting to server', 'error');
      }
    }
  </script>
  
  <script>
    // Function to set up general event listeners
    function setupEventListeners() {
      console.log('Setting up event listeners...');
      
      // Logout button
      const logoutBtn = document.getElementById('logout');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
          localStorage.removeItem('userId');
          localStorage.removeItem('accessToken');
          window.location.href = '/';
        });
      }
      
      // Add Topic Modal
      const addTopicModal = document.getElementById('addTopicModal');
      const showAddTopicModalBtn = document.getElementById('showAddTopicModal');
      const closeAddTopicModalBtn = document.getElementById('closeAddTopicModal');
      const addTopicForm = document.getElementById('addTopicForm');
      
      if (showAddTopicModalBtn && addTopicModal && closeAddTopicModalBtn) {
        showAddTopicModalBtn.addEventListener('click', () => {
          addTopicModal.classList.remove('hidden');
        });
        closeAddTopicModalBtn.addEventListener('click', () => {
          addTopicModal.classList.add('hidden');
        });
      }
      
      if (addTopicForm) {
        addTopicForm.addEventListener('submit', handleAddTopicSubmit);
      }
      
      // Close Topic Modal
      const closeTopicModalBtn = document.getElementById('closeTopicModal');
      const topicModal = document.getElementById('topicModal');
      if (closeTopicModalBtn && topicModal) {
        closeTopicModalBtn.addEventListener('click', () => {
          topicModal.classList.add('hidden');
          document.body.style.overflow = ''; // Restore body scroll
        });
      }
      
      // Generate Summary Button
      const generateSummaryBtn = document.getElementById('generateSummaryBtn');
      if (generateSummaryBtn) {
        generateSummaryBtn.addEventListener('click', generateSummary);
      }
      
      // Save Note Button (within modal)
      const saveNoteBtn = document.getElementById('saveNoteBtn');
      if (saveNoteBtn) {
        // Check if the function exists before attaching it
        if (typeof handleSaveNote === 'function') {
          saveNoteBtn.addEventListener('click', handleSaveNote);
        } else {
          // Provide a placeholder function to prevent errors
          saveNoteBtn.addEventListener('click', () => {
            console.warn('handleSaveNote function is not defined');
            showToast('Note saving is not available', 'error');
          });
        }
      }
      
      // Tab switching inside the modal
      const modal = document.getElementById('topicModal');
      if (modal) {
        const tabButtons = modal.querySelectorAll('.tab-button');
        const tabContents = modal.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
          button.addEventListener('click', () => {
            const tabName = button.getAttribute('data-tab');
            
            // Update button states
            tabButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            // Update content visibility
            tabContents.forEach(content => {
              if (content.id === `${tabName}Tab`) {
                content.classList.remove('hidden');
              } else {
                content.classList.add('hidden');
              }
            });
            
            // Special loading logic if needed (already handled in openTopicModal)
            // Example: if (tabName === 'summary' && !summaryLoaded) loadSummary(); 
          });
        });
      }
      
      console.log('Event listeners set up.');
    }
  </script>
</body>
</html>
