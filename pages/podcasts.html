<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Podcasts - Koda Tutor</title>
  <link rel="stylesheet" href="../styles/main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="../scripts/utils.js" defer></script>
</head>
<body class="bg-gray-50 font-eb-garamond min-h-screen flex text-gray-900">
  <!-- Mobile Hamburger - Using the same approach as dashboard -->
  <div class="md:hidden fixed top-4 left-4 z-50 cursor-pointer p-2 mobile-touch-target" id="hamburger">
    <div class="w-6 h-0.5 bg-gray-800 mb-1"></div>
    <div class="w-6 h-0.5 bg-gray-800 mb-1"></div>
    <div class="w-6 h-0.5 bg-gray-800"></div>
  </div>

  <!-- Sidebar Navigation -->
  <div id="sidebar" class="fixed top-0 left-0 h-screen w-56 bg-blue-50 shadow-md transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-40">
    <div class="flex flex-col h-full">
      <div class="p-5 pt-12 md:pt-5 border-b border-blue-100">
        <h1 class="text-xl font-bold text-gray-800">Koda Tutor</h1>
        <!-- Close button for mobile -->
        <button id="closeSidebar" class="absolute top-5 right-4 text-gray-500 hover:text-gray-700 md:hidden mobile-touch-target">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <nav class="flex-1 overflow-y-auto py-4">
        <ul class="space-y-2 px-4">
          <li class="flex-col space-y-2">
            <a href="dashboard.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-blue-100 hover:text-blue-800 transition-colors mobile-touch-target">
              <i class="fas fa-compass"></i>
              <span class="mobile-readable">Dashboard</span>
            </a>
            <a href="chat.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-blue-100 hover:text-blue-800 transition-colors mobile-touch-target">
              <i class="fas fa-comments"></i>
              <span class="mobile-readable">Chat</span>
            </a>
            <a href="bookmarks.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-blue-100 hover:text-blue-800 transition-colors mobile-touch-target">
              <i class="fas fa-bookmark"></i>
              <span class="mobile-readable">Bookmarks</span>
            </a>
            <a href="#" id="notesToggle" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-blue-100 hover:text-blue-800 transition-colors mobile-touch-target">
              <i class="fas fa-sticky-note"></i>
              <span class="mobile-readable">Notes</span>
            </a>
            <a href="podcasts.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg bg-blue-100 text-blue-800 mobile-touch-target">
              <i class="fas fa-podcast"></i>
              <span class="mobile-readable">Podcasts</span>
            </a>
            <a href="settings.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-blue-100 hover:text-blue-800 transition-colors mobile-touch-target">
              <i class="fas fa-cog"></i>
              <span class="mobile-readable">Settings</span>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="main-content-area md:ml-56 flex-1 p-4 md:p-6">
    <!-- Upload Card -->
    <div class="bg-white p-6 rounded-lg shadow-sm mb-6 max-w-3xl mx-auto">
      <h1 class="text-2xl md:text-3xl font-bold text-center mb-6">Upload a Podcast PDF</h1>

      <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 flex flex-col items-center justify-center cursor-pointer mb-6">
        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-3"></i>
        <p class="text-center mb-2">Click to upload or drag and drop</p>
        <p class="text-sm text-gray-500">PDF files only (Max. 10MB)</p>
        <input type="file" id="pdfInput" accept=".pdf" class="hidden" />
      </div>

      <div class="flex justify-center">
        <button id="uploadButton" class="flex items-center bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-md transition-colors" disabled>
          <i class="fas fa-upload mr-2"></i> Upload
        </button>
      </div>
    </div>
    
    <!-- Message and Loading Indicator -->
    <div class="message text-center mt-4" id="message"></div>

    <div id="loadingIndicator" class="hidden text-center py-4">
      <i class="fas fa-spinner fa-spin text-blue-500 text-3xl"></i>
      <p class="text-gray-600 mt-2">Generating your podcast. This may take several minutes...</p>
    </div>

    <!-- Podcasts List Section -->
    <div class="bg-white p-6 rounded-lg shadow-sm mt-8 max-w-3xl mx-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl md:text-2xl font-bold">Your Podcasts</h2>
        <button id="refreshPodcasts" class="text-blue-500 hover:text-blue-700 p-2 rounded-full hover:bg-blue-50 transition-colors">
          <i class="fas fa-sync"></i>
        </button>
      </div>

      <div id="podcastList" class="space-y-4"></div>
    </div>
  </div>

  <script>
    const pdfInput = document.getElementById('pdfInput');
    const uploadButton = document.getElementById('uploadButton');
    const messageDiv = document.getElementById('message');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const podcastList = document.getElementById('podcastList');

    function showMessage(msg, type) {
      messageDiv.textContent = msg;
      messageDiv.className = 'message ' + (type || '');
    }
    
    // File input change handler
    pdfInput.addEventListener('change', function() {
      if (this.files.length > 0) {
        const file = this.files[0];
        uploadButton.disabled = false;
        messageDiv.textContent = `Selected: ${file.name}`;
        messageDiv.className = 'message';
      } else {
        uploadButton.disabled = true;
        messageDiv.textContent = '';
      }
    });

    uploadButton.addEventListener('click', async () => {
      const file = pdfInput.files[0];
      showMessage('', '');
      loadingIndicator.classList.remove('hidden');

      if (!file) {
        showMessage('Please select a PDF file to upload.', 'error');
        loadingIndicator.classList.add('hidden');
        return;
      }
      if (file.type !== 'application/pdf') {
        showMessage('Invalid file type. Only PDF files are allowed.', 'error');
        loadingIndicator.classList.add('hidden');
        return;
      }
      if (file.size > 10 * 1024 * 1024) {
        showMessage('File is too large (max 10MB).', 'error');
        loadingIndicator.classList.add('hidden');
        return;
      }

      const formData = new FormData();
      formData.append('pdf', file);
      uploadButton.disabled = true;
      showMessage('Uploading and processing PDF...');
      try {
        const res = await fetch('/.netlify/functions/upload-pdf', {
          method: 'POST',
          body: formData
        });

        const data = await res.json();

        if (res.ok) {
          showMessage('PDF processed successfully!', 'success');
          if (data.extractedText) {
            // Update UI with extracted text
          } else if (data.error) {
            showMessage(`Processing finished, but: ${data.error}`, 'error');
          } else {
            showMessage('PDF uploaded, but no text could be extracted.', 'error');
          }
          pdfInput.value = '';
        } else {
          const errorMsg = data.error || 'Upload failed. Please try again.';
          showMessage(errorMsg, 'error');
        }
      } catch (err) {
        console.error('Upload error:', err);
        showMessage('Upload failed due to a network or server issue.', 'error');
      } finally {
        uploadButton.disabled = false;
        loadingIndicator.classList.add('hidden');
      }
    });

    // Function to load user's generated podcasts
    async function loadPodcasts() {
      try {
        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
          podcastList.innerHTML = '<div class="text-center py-4 text-red-600">Please log in to view your podcasts</div>';
          return;
        }

        const response = await fetch('/.netlify/functions/list-podcasts', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${accessToken}`
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load podcasts');
        }

        const data = await response.json();

        if (!data.podcasts || data.podcasts.length === 0) {
          podcastList.innerHTML = '<div class="text-center py-4 text-gray-500">No podcasts found. Upload a PDF to generate your first podcast!</div>';
          return;
        }

        // Render podcasts
        let podcastsHTML = '';
        data.podcasts.forEach(podcast => {
          const date = new Date(podcast.created_at).toLocaleDateString();
          const topicsHtml = podcast.topics ? `
            <div class="flex flex-wrap gap-1 mt-2">
              ${podcast.topics.split(',').map(topic => topic.trim()).map(topic => `<span class="bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded">${topic}</span>`).join('')}
            </div>
          ` : '';

          podcastsHTML += `
            <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
              <div class="flex justify-between items-start">
                <div>
                  <h3 class="text-lg font-semibold">${podcast.title || 'Untitled Podcast'}</h3>
                  <p class="text-xs text-gray-500">${date}</p>
                  ${topicsHtml}
                </div>
                <button class="delete-podcast text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50" data-id="${podcast.job_id}">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
              <div class="podcast-player mt-3">
                <audio controls src="${podcast.audio_url}"></audio>
                <div class="flex justify-end">
                  <a href="${podcast.audio_url}" download target="_blank" class="inline-flex items-center">
                    <i class="fas fa-download mr-1"></i> Download
                  </a>
                </div>
              </div>
            </div>
          `;
        });
        
        podcastList.innerHTML = podcastsHTML;
      } catch (error) {
        console.error('Error loading podcasts:', error);
        podcastList.innerHTML = `
          <div class="text-center py-4 text-red-600">
            Failed to load podcasts. 
            <button id="retryLoadBtn" class="text-blue-600 hover:underline ml-2">Try Again</button>
          </div>
        `;
        
        document.getElementById('retryLoadBtn')?.addEventListener('click', loadPodcasts);
      }
    }

    // Set up refresh button
    document.getElementById('refreshPodcastsBtn').addEventListener('click', loadPodcasts);
    
    // Load podcasts when page loads
    document.addEventListener('DOMContentLoaded', loadPodcasts);
    
    // Also load podcasts when a new one is successfully created
    function reloadPodcastsAfterCreation() {
      setTimeout(loadPodcasts, 1000); // Delay to ensure database is updated
    }
    
    // Modify the checkPodcastStatus function to reload podcast list when complete
    const originalCheckPodcastStatus = checkPodcastStatus;
    checkPodcastStatus = async function(jobId) {
      await originalCheckPodcastStatus(jobId);
      // Check if we have a completed podcast and reload list
      const podcastPlayerElement = document.querySelector('.podcast-player');
      if (podcastPlayerElement) {
        reloadPodcastsAfterCreation();
      }
    };
    
    // Function to handle podcast deletion
    async function deletePodcast(podcastId) {
      if (!podcastId) return;
      
      if (!confirm('Are you sure you want to delete this podcast? This cannot be undone.')) {
        return;
      }
      
      try {
        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
          alert('You need to be logged in to delete podcasts');
          return;
        }
        
        const response = await fetch(`/.netlify/functions/delete-podcast?jobId=${podcastId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${accessToken}`
          }
        });
        
        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Failed to delete podcast');
        }
        
        // Show success message and reload the list
        showMessage('Podcast deleted successfully', 'success');
        loadPodcasts();
      } catch (error) {
        console.error('Error deleting podcast:', error);
        showMessage(`Failed to delete podcast: ${error.message}`, 'error');
      }
    }
    
    // Add event delegation for delete buttons
    document.getElementById('podcastList').addEventListener('click', event => {
      const deleteBtn = event.target.closest('.delete-podcast-btn');
      if (deleteBtn) {
        const podcastId = deleteBtn.dataset.podcastId;
        deletePodcast(podcastId);
      }
    });
    // Add standard navigation event handlers - same as dashboard.html
    document.addEventListener('DOMContentLoaded', function() {
      const hamburger = document.getElementById('hamburger');
      const sidebar = document.getElementById('sidebar');
      const closeSidebar = document.getElementById('closeSidebar');
      
      // Check if user is logged in
      const accessToken = localStorage.getItem('accessToken');
      if (!accessToken) {
        window.location.href = '/pages/login.html';
        return;
      }
      
      // Setup mobile navigation (consistent with dashboard.html)
      if (hamburger) {
        hamburger.addEventListener('click', function() {
          sidebar.classList.toggle('translate-x-0');
        });
      }
      
      if (closeSidebar) {
        closeSidebar.addEventListener('click', function() {
          sidebar.classList.remove('translate-x-0');
        });
      }
      
      // Setup drag-and-drop functionality
      const dropzone = document.querySelector('.border-dashed');
      const pdfInput = document.getElementById('pdfInput');
      
      if (dropzone && pdfInput) {
        // Click to select file
        dropzone.addEventListener('click', function() {
          pdfInput.click();
        });
        
        // Drag over
        dropzone.addEventListener('dragover', function(e) {
          e.preventDefault();
          e.stopPropagation();
          dropzone.classList.add('border-blue-400');
          dropzone.classList.add('bg-blue-50');
        });
        
        // Drag leave
        dropzone.addEventListener('dragleave', function(e) {
          e.preventDefault();
          e.stopPropagation();
          dropzone.classList.remove('border-blue-400');
          dropzone.classList.remove('bg-blue-50');
        });
        
        // Drop
        dropzone.addEventListener('drop', function(e) {
          e.preventDefault();
          e.stopPropagation();
          dropzone.classList.remove('border-blue-400');
          dropzone.classList.remove('bg-blue-50');
          
          if (e.dataTransfer.files.length > 0) {
            // Check if it's a PDF
            const file = e.dataTransfer.files[0];
            if (file.type === 'application/pdf') {
              pdfInput.files = e.dataTransfer.files;
              // Trigger the change event
              const event = new Event('change');
              pdfInput.dispatchEvent(event);
            } else {
              showMessage('Only PDF files are allowed.', 'error');
            }
          }
        });
      }
    });
  </script>
</body>
</html>